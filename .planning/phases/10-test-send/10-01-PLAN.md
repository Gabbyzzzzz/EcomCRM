---
phase: 10-test-send
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/send-test-email-button.tsx
  - src/components/automation-detail-client.tsx
  - src/app/(dashboard)/automations/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Send Test Email on the automation detail page and receive a real email in their inbox within seconds"
    - "The test email uses the current in-form values (subject, body, discount code) — editing a field and immediately sending test reflects the edit without saving first"
    - "User sees loading state while sending and a success or error message after"
  artifacts:
    - path: "src/components/send-test-email-button.tsx"
      provides: "Send test email button that forwards current form content to the API"
      contains: "subject.*body.*discountCode"
    - path: "src/components/automation-detail-client.tsx"
      provides: "Client wrapper rendering SendTestEmailButton with live form values"
      contains: "SendTestEmailButton"
    - path: "src/app/(dashboard)/automations/[id]/page.tsx"
      provides: "Server page without standalone SendTestEmailButton — button now lives inside AutomationDetailClient"
  key_links:
    - from: "src/components/automation-detail-client.tsx"
      to: "src/components/send-test-email-button.tsx"
      via: "props passing current actionConfig values"
      pattern: "previewSubject|previewBody|previewDiscountCode"
    - from: "src/components/send-test-email-button.tsx"
      to: "/api/automations/[id]/send-test"
      via: "fetch POST with subject, body, discountCode in request body"
      pattern: "JSON\\.stringify.*subject.*body"
---

<objective>
Wire the existing "Send Test Email" button to forward the current in-form content (subject, body, discount code, headline, ctaText) to the already-functional send-test API endpoint.

Purpose: The send-test API route (Phase 09-03) already accepts body params with three-layer priority (body > DB config > defaults). The current SendTestEmailButton only sends `{ email }` and is rendered outside AutomationDetailClient, so it has no access to form state. This plan moves the button inside AutomationDetailClient and passes the live form values through, fulfilling TSEND-01 and TSEND-02.

Output: Updated SendTestEmailButton component, updated AutomationDetailClient, updated page.tsx
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/send-test-email-button.tsx
@src/components/automation-detail-client.tsx
@src/app/(dashboard)/automations/[id]/page.tsx
@src/app/api/automations/[id]/send-test/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SendTestEmailButton to accept and forward form content overrides</name>
  <files>src/components/send-test-email-button.tsx</files>
  <action>
Update SendTestEmailButton to accept optional props for the current form content and include them in the send-test API call.

Add these optional props to SendTestEmailButtonProps:
- `subject?: string` — current email subject from form
- `headline?: string` — current headline from form
- `body?: string` — current body text from form
- `ctaText?: string` — current CTA text from form
- `discountCode?: string` — current discount code from form

In the `handleSend` function, update the `JSON.stringify` body to include all non-undefined props alongside the `email` field:
```ts
body: JSON.stringify({
  email,
  ...(subject ? { subject } : {}),
  ...(headline ? { headline } : {}),
  ...(body ? { body } : {}),
  ...(ctaText ? { ctaText } : {}),
  ...(discountCode ? { discountCode } : {}),
}),
```

Use the name `bodyText` for the body prop (to avoid collision with the HTML body keyword / JSON.stringify body parameter) and map it to `body` in the fetch payload.

Keep all existing UI (email input, send button, status messages, helper text). No visual changes needed — the component just gains the ability to forward content overrides.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` passes with no errors on send-test-email-button.tsx</verify>
  <done>SendTestEmailButton accepts optional subject/headline/bodyText/ctaText/discountCode props and includes them in the POST body to /api/automations/[id]/send-test</done>
</task>

<task type="auto">
  <name>Task 2: Move SendTestEmailButton inside AutomationDetailClient and wire form values; clean up page.tsx</name>
  <files>src/components/automation-detail-client.tsx, src/app/(dashboard)/automations/[id]/page.tsx</files>
  <action>
**In automation-detail-client.tsx:**

1. Import `SendTestEmailButton` from `@/components/send-test-email-button`.

2. After the grid containing AutomationConfigForm and EmailPreviewPanel, add a "Send Test Email" section. Place it below the grid but still inside the AutomationDetailClient return. Use the same card-style section that was in page.tsx:
```tsx
{/* Send Test Email */}
<div className="mt-6">
  <h3 className="text-base font-medium mb-1">Send Test Email</h3>
  <p className="text-sm text-muted-foreground mb-3">
    Send a test version with your current edits — no need to save first
  </p>
  <SendTestEmailButton
    automationId={automationId}
    subject={previewSubject}
    headline={previewHeadline}
    bodyText={previewBody}
    ctaText={previewCtaText}
    discountCode={previewDiscountCode}
  />
</div>
```

The `previewSubject`, `previewHeadline`, `previewBody`, `previewCtaText`, `previewDiscountCode` variables already exist in AutomationDetailClient (derived from `values.actionConfig`). Pass them directly. Note: the prop name is `bodyText` (not `body`) per Task 1.

**In page.tsx:**

1. Remove the import of `SendTestEmailButton` from the imports.
2. Remove the entire "Send Test Email" section (the `<div className="rounded-lg border bg-card p-6">` block containing `<SendTestEmailButton automationId={automation.id} />`).
3. Keep the `AutomationDetailClient` and `EmailCopyGenerator` sections unchanged.

The card border styling for the test send section is now handled inside AutomationDetailClient rather than as a separate bordered section in page.tsx. Adjust the wrapper styling as needed — a simple `mt-6` divider is sufficient since it's inside the existing "Configuration" card.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors.
2. Verify SendTestEmailButton import removed from page.tsx: `grep -c "SendTestEmailButton" src/app/\(dashboard\)/automations/\[id\]/page.tsx` returns 0.
3. Verify SendTestEmailButton now imported in automation-detail-client.tsx: `grep -c "SendTestEmailButton" src/components/automation-detail-client.tsx` returns a value > 0.
  </verify>
  <done>
SendTestEmailButton is rendered inside AutomationDetailClient with live form values (subject, headline, body, ctaText, discountCode) passed as props. The page.tsx no longer renders a standalone SendTestEmailButton. Editing any field in the config form and clicking "Send Test Email" sends the current in-form content to the API without requiring a save.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — full project compiles without TypeScript errors
2. `npm run build` — Next.js build succeeds (catches any SSR/RSC issues from import changes)
3. Manual verification: on the automation detail page, the "Send Test Email" section appears below the config form/preview grid, inside the Configuration card. Entering a custom subject in the form and immediately sending a test email delivers the email with that custom subject (prefixed with [TEST]).
</verification>

<success_criteria>
- TSEND-01: "Send Test Email" button on automation detail page delivers preview to user's own inbox — fulfilled by SendTestEmailButton inside AutomationDetailClient calling the existing send-test API
- TSEND-02: Test email uses currently customized content (not just defaults) — fulfilled by passing live form values (previewSubject, previewBody, etc.) as props to SendTestEmailButton, which includes them in the POST body
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-send/10-01-SUMMARY.md`
</output>
