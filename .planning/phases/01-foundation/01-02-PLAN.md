---
phase: 01-foundation
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - next.config.mjs
  - src/lib/env.ts
  - .env.local.example
  - src/inngest/client.ts
  - src/inngest/functions.ts
  - src/app/api/inngest/route.ts
autonomous: true

user_setup:
  - service: supabase
    why: "PostgreSQL database — all app data stored here"
    env_vars:
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Settings -> Database -> Connection string -> Transaction (port 6543)"
        note: "Must use port 6543 (Transaction mode pooler), NOT port 5432"
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role (secret)"
  - service: shopify
    why: "Shopify Custom App access for customer/order data"
    env_vars:
      - name: SHOPIFY_STORE_URL
        source: "Your store URL, e.g. https://your-store.myshopify.com"
      - name: SHOPIFY_ACCESS_TOKEN
        source: "Shopify Admin -> Apps and sales channels -> Develop apps -> Your App -> API credentials -> Admin API access token"
      - name: SHOPIFY_WEBHOOK_SECRET
        source: "Shopify Admin -> Apps and sales channels -> Develop apps -> Your App -> API credentials -> Webhooks -> Signing secret"
  - service: resend
    why: "Transactional email sending"
    env_vars:
      - name: RESEND_API_KEY
        source: "resend.com -> API Keys -> Create API Key"
  - service: anthropic
    why: "AI insights and email copy generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "console.anthropic.com -> API Keys"
  - service: inngest
    why: "Background job scheduling and event queues"
    env_vars:
      - name: INNGEST_EVENT_KEY
        source: "app.inngest.com -> Your App -> Event Keys (for production; can use placeholder in local dev with Inngest Dev Server)"
      - name: INNGEST_SIGNING_KEY
        source: "app.inngest.com -> Your App -> Signing Key"

must_haves:
  truths:
    - "Running `npm run build` succeeds without ESM/CJS errors from @react-email packages"
    - "Starting the app with a missing env var throws a clear error listing exactly which vars are missing"
    - "A GET to /api/inngest returns HTTP 200"
    - "All 10 env vars are documented in .env.local.example with instructions for obtaining each value"
  artifacts:
    - path: "src/lib/env.ts"
      provides: "Zod-validated env singleton — all app code imports env from here"
      exports: ["env"]
      contains: "DATABASE_URL"
    - path: ".env.local.example"
      provides: "Template for .env.local — git-tracked, no real secrets"
      contains: "DATABASE_URL="
    - path: "src/inngest/client.ts"
      provides: "Inngest client singleton"
      exports: ["inngest"]
    - path: "src/inngest/functions.ts"
      provides: "Empty functions array — placeholder for later phases"
      exports: ["functions"]
    - path: "src/app/api/inngest/route.ts"
      provides: "Next.js App Router serve handler for Inngest"
      exports: ["GET", "POST", "PUT"]
    - path: "next.config.mjs"
      provides: "Next.js config with React Email server external packages"
      contains: "serverExternalPackages"
  key_links:
    - from: "src/lib/db/index.ts"
      to: "src/lib/env.ts"
      via: "import { env } from '@/lib/env'"
      pattern: "from '@/lib/env'"
    - from: "src/app/api/inngest/route.ts"
      to: "src/inngest/client.ts"
      via: "import { inngest } from '@/inngest/client'"
      pattern: "from '@/inngest/client'"
    - from: "src/app/api/inngest/route.ts"
      to: "src/inngest/functions.ts"
      via: "import { functions } from '@/inngest/functions'"
      pattern: "from '@/inngest/functions'"
---

<objective>
Install missing packages, configure Next.js for React Email compatibility, establish Zod env validation, and wire up the Inngest background job client and serve handler.

Purpose: The env validation module is the safety net for all external service configuration — it catches misconfiguration at startup rather than at runtime. The Inngest handler establishes the event processing endpoint that all async work flows through in later phases. The React Email serverExternalPackages config prevents build failures.

Output: env.ts (validated env singleton), .env.local.example (template), inngest client, functions placeholder, /api/inngest serve handler, updated next.config.mjs.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install missing packages, env validation, and next.config update</name>
  <files>
    package.json
    package-lock.json
    next.config.mjs
    src/lib/env.ts
    .env.local.example
  </files>
  <action>
    STEP 1 — Install missing packages:
    ```bash
    npm install @react-email/render decimal.js
    ```
    Both were confirmed missing from package.json (research verified: @react-email/render is a nested dep only, decimal.js is absent entirely).

    STEP 2 — Update `next.config.mjs` to add serverExternalPackages (required to prevent Next.js bundler from failing on React Email's Node.js-only internals):
    ```javascript
    /** @type {import('next').NextConfig} */
    const nextConfig = {
      serverExternalPackages: ['@react-email/render', '@react-email/components'],
    }

    export default nextConfig
    ```

    STEP 3 — Create `src/lib/env.ts`:
    ```typescript
    import { z } from 'zod'

    // Use z.string().min(1) for all env vars — avoids Zod 4.x deprecated method-form format validators
    const envSchema = z.object({
      // Database — must use Supabase Transaction Mode Pooler (port 6543)
      DATABASE_URL: z.string().min(1),

      // Supabase
      NEXT_PUBLIC_SUPABASE_URL: z.string().min(1),
      SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),

      // Shopify Custom App (NOT Public App — access token directly, no OAuth)
      SHOPIFY_STORE_URL: z.string().min(1),
      SHOPIFY_ACCESS_TOKEN: z.string().min(1),
      SHOPIFY_WEBHOOK_SECRET: z.string().min(1),

      // Resend (email sending)
      RESEND_API_KEY: z.string().min(1),

      // Anthropic (AI insights)
      ANTHROPIC_API_KEY: z.string().min(1),

      // Inngest (background jobs)
      INNGEST_EVENT_KEY: z.string().min(1),
      INNGEST_SIGNING_KEY: z.string().min(1),
    })

    const result = envSchema.safeParse(process.env)

    if (!result.success) {
      console.error('❌ Missing or invalid environment variables:')
      console.error(result.error.flatten().fieldErrors)
      throw new Error('Environment validation failed. Check the logs above for missing variables.')
    }

    export const env = result.data
    ```

    IMPORTANT: Do NOT import env.ts in next.config.mjs — next.config runs in a context that may not have access to all env vars. Import env.ts only in server-side code (API routes, server components, lib files).

    STEP 4 — Create `.env.local.example` at project root (git-tracked, no real secrets):
    ```bash
    # EcomCRM — Environment Variables
    # Copy this file to .env.local and fill in your values
    # NEVER commit .env.local to git

    # ─── Database ───────────────────────────────────────────────
    # Use Supabase Transaction Mode Pooler (port 6543), NOT the direct connection (port 5432)
    # Direct connection exhausts Supabase's connection limit under serverless concurrency
    # Format: postgres://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres
    DATABASE_URL=

    # ─── Supabase ────────────────────────────────────────────────
    # Project URL: Supabase Dashboard -> Settings -> API -> Project URL
    NEXT_PUBLIC_SUPABASE_URL=
    # Service role key: Supabase Dashboard -> Settings -> API -> service_role (secret)
    SUPABASE_SERVICE_ROLE_KEY=

    # ─── Shopify Custom App ───────────────────────────────────────
    # This is a Custom App (NOT a Public App) — no OAuth, just an access token
    # Store URL: e.g. https://your-store.myshopify.com
    SHOPIFY_STORE_URL=
    # Access token: Shopify Admin -> Apps -> Develop apps -> [Your App] -> API credentials -> Admin API access token
    SHOPIFY_ACCESS_TOKEN=
    # Webhook secret: Shopify Admin -> Apps -> Develop apps -> [Your App] -> API credentials -> Webhooks -> Signing secret
    SHOPIFY_WEBHOOK_SECRET=

    # ─── Resend (email) ───────────────────────────────────────────
    # API key: resend.com -> API Keys -> Create API Key (with send permission)
    RESEND_API_KEY=

    # ─── Anthropic (AI) ───────────────────────────────────────────
    # API key: console.anthropic.com -> API Keys -> Create Key
    ANTHROPIC_API_KEY=

    # ─── Inngest (background jobs) ────────────────────────────────
    # Local dev: run `npx inngest-cli@latest dev` — placeholder values work with Dev Server
    # Production: app.inngest.com -> Your App -> Event Keys / Signing Key
    INNGEST_EVENT_KEY=
    INNGEST_SIGNING_KEY=
    ```
  </action>
  <verify>
    Run: `cat package.json | grep -E '"@react-email/render"|"decimal.js"'`
    Expected: Both packages appear in dependencies.

    Run: `grep "serverExternalPackages" next.config.mjs`
    Expected: Line found with @react-email/render and @react-email/components.

    Run: `grep -c "z.string().min(1)" src/lib/env.ts`
    Expected: 10 (one per env var).

    Run: `grep -c "^[A-Z_]*=" .env.local.example`
    Expected: 10 or more blank env var declarations.
  </verify>
  <done>
    package.json includes @react-email/render and decimal.js in dependencies. next.config.mjs has serverExternalPackages for both react-email packages. src/lib/env.ts validates all 10 env vars using Zod with z.string().min(1). .env.local.example documents all 10 vars with source instructions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inngest client, functions placeholder, and serve handler</name>
  <files>
    src/inngest/client.ts
    src/inngest/functions.ts
    src/app/api/inngest/route.ts
  </files>
  <action>
    Create `src/inngest/client.ts`:
    ```typescript
    import { Inngest } from 'inngest'

    export const inngest = new Inngest({ id: 'ecomcrm' })
    ```

    Create `src/inngest/functions.ts` as an empty placeholder (functions are added in later phases):
    ```typescript
    // Inngest functions — registered here as they are created in later phases
    // Phase 2+: sync functions, RFM cron, automation triggers
    import type { GetFunctionOutput } from 'inngest'

    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    export const functions: GetFunctionOutput<any>[] = []
    ```

    NOTE: The `GetFunctionOutput<any>` type is necessary here because the functions array is empty. Later phases will replace this with a properly typed union. The `any` usage is intentional and isolated to this placeholder.

    Create `src/app/api/inngest/route.ts`:
    ```typescript
    import { serve } from 'inngest/next'
    import { inngest } from '@/inngest/client'
    import { functions } from '@/inngest/functions'

    export const { GET, POST, PUT } = serve({
      client: inngest,
      functions,
    })
    ```

    Verify the directory exists before creating the route file:
    The path `src/app/api/inngest/` must be created if it doesn't exist (Next.js App Router convention: each segment is a directory).
  </action>
  <verify>
    Run: `npm run build 2>&1 | tail -20`
    Expected: Build succeeds with no ESM/CJS errors. If build fails due to missing .env.local, that is expected (env validation throws) — look specifically for React Email bundling errors, NOT env errors.

    To check without env: `grep -r "serve" src/app/api/inngest/route.ts`
    Expected: Line with `serve({ client: inngest, functions })`

    Run: `npx tsc --noEmit 2>&1 | grep -v "env.ts" | head -20`
    Expected: No TypeScript errors in inngest files.

    To verify the endpoint works at runtime, start the dev server with a valid .env.local:
    ```bash
    npm run dev
    # In another terminal:
    curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/inngest
    ```
    Expected: 200
  </verify>
  <done>
    src/inngest/client.ts exports `inngest` singleton with id 'ecomcrm'. src/inngest/functions.ts exports an empty `functions` array. src/app/api/inngest/route.ts exports GET, POST, PUT from serve(). TypeScript compiles without errors in the inngest files. GET /api/inngest returns 200 when the app is running.
  </done>
</task>

</tasks>

<verification>
1. `grep "@react-email/render" package.json` — appears in dependencies
2. `grep "decimal.js" package.json` — appears in dependencies
3. `grep "serverExternalPackages" next.config.mjs` — found
4. `node -e "const {z}=require('zod'); console.log('zod ok')"` — no import errors
5. `grep -c "DATABASE_URL\|SHOPIFY\|RESEND\|ANTHROPIC\|INNGEST" src/lib/env.ts` — at least 10 matches
6. `cat src/inngest/client.ts` — shows `new Inngest({ id: 'ecomcrm' })`
7. `cat src/app/api/inngest/route.ts` — shows `serve({ client: inngest, functions })`
</verification>

<success_criteria>
- @react-email/render and decimal.js appear in package.json dependencies
- next.config.mjs has serverExternalPackages: ['@react-email/render', '@react-email/components']
- src/lib/env.ts validates all 10 required env vars and throws a clear error if any are missing
- .env.local.example documents all 10 vars with source instructions (no real values)
- src/inngest/client.ts exports the Inngest singleton
- src/inngest/functions.ts exports an empty functions array
- src/app/api/inngest/route.ts exports GET, POST, PUT from inngest serve()
- GET /api/inngest returns 200 when app runs with valid .env.local
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md` with:
- Packages installed (versions confirmed from package.json)
- Env vars validated (list all 10 var names)
- Inngest endpoint status (200 confirmed or pending .env.local setup)
- Any deviations from the plan
</output>
