---
phase: 01-foundation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/db/index.ts
  - src/lib/db/queries.ts
  - drizzle.config.ts
  - drizzle/
autonomous: true

must_haves:
  truths:
    - "Running `npx drizzle-kit generate` produces SQL with CREATE TYPE for all 6 enums before CREATE TABLE statements"
    - "All 4 tables (customers, orders, automations, message_logs) have the correct columns and indexes"
    - "The db singleton connects via port 6543 with prepare: false (PgBouncer-safe)"
    - "Running `npx drizzle-kit migrate` applies migrations to Supabase without errors"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "All Drizzle table + enum definitions"
      exports:
        - customerSegmentEnum
        - triggerTypeEnum
        - actionTypeEnum
        - messageChannelEnum
        - messageStatusEnum
        - financialStatusEnum
        - customers
        - orders
        - automations
        - messageLogs
    - path: "src/lib/db/index.ts"
      provides: "db singleton and DB type export"
      exports: ["db", "DB"]
    - path: "src/lib/db/queries.ts"
      provides: "Empty module for future query functions"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration pointing to schema"
      contains: "dialect: 'postgresql'"
    - path: "drizzle/"
      provides: "Generated migration SQL files (git-tracked)"
  key_links:
    - from: "src/lib/db/index.ts"
      to: "src/lib/db/schema.ts"
      via: "import * as schema from './schema'"
      pattern: "import \\* as schema from"
    - from: "src/lib/db/index.ts"
      to: "src/lib/env.ts"
      via: "import { env } from '@/lib/env'"
      pattern: "import.*env.*from.*@/lib/env"
    - from: "drizzle.config.ts"
      to: "src/lib/db/schema.ts"
      via: "schema: './src/lib/db/schema.ts'"
      pattern: "schema.*src/lib/db/schema"
---

<objective>
Establish the complete Drizzle ORM schema for all 4 database tables plus the migration workflow and db connection singleton.

Purpose: Every subsequent phase reads/writes to the database. This plan creates the schema that defines the data model, configures the Drizzle Kit migration toolchain, and establishes the db singleton with the PgBouncer-safe connection settings required for Supabase serverless.

Output: schema.ts (all tables + enums), db/index.ts (singleton), drizzle.config.ts, and generated migration SQL in ./drizzle/.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Drizzle schema, DB singleton, and migration config</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/index.ts
    src/lib/db/queries.ts
    drizzle.config.ts
  </files>
  <action>
    Create `src/lib/db/schema.ts` with ALL of the following exported at top level (drizzle-kit silently skips non-exported enums):

    ENUMS (export each with `export const`):
    - `customerSegmentEnum = pgEnum('customer_segment', ['champion','loyal','potential','new','at_risk','hibernating','lost'])`
    - `triggerTypeEnum = pgEnum('trigger_type', ['first_order','segment_change','days_since_order','tag_added','cart_abandoned'])`
    - `actionTypeEnum = pgEnum('action_type', ['send_email','add_tag','remove_tag'])`
    - `messageChannelEnum = pgEnum('message_channel', ['email','sms'])`
    - `messageStatusEnum = pgEnum('message_status', ['sent','opened','clicked','converted'])`
    - `financialStatusEnum = pgEnum('financial_status', ['pending','authorized','paid','refunded','voided'])`

    TABLE: `customers` — columns: id (uuid PK defaultRandom), shopId (varchar 255 notNull), shopifyId (varchar 255 notNull), name (varchar 255), email (varchar 255), phone (varchar 50), rfmR (integer), rfmF (integer), rfmM (integer), segment (customerSegmentEnum), lifecycleStage (varchar 100), tags (text array), totalSpent (numeric precision:19 scale:4), orderCount (integer default 0), avgOrderValue (numeric precision:19 scale:4), firstOrderAt (timestamp withTimezone), lastOrderAt (timestamp withTimezone), createdAt (timestamp withTimezone defaultNow notNull). Indexes: shop_id, shopify_id, segment, email.

    TABLE: `orders` — columns: id (uuid PK defaultRandom), shopId (varchar 255 notNull), shopifyId (varchar 255 notNull), customerId (uuid FK → customers.id), totalPrice (numeric precision:19 scale:4), lineItems (jsonb), financialStatus (financialStatusEnum), createdAt (timestamp withTimezone defaultNow notNull). Indexes: shop_id, customer_id, created_at.

    TABLE: `automations` — columns: id (uuid PK defaultRandom), shopId (varchar 255 notNull), name (varchar 255 notNull), triggerType (triggerTypeEnum notNull), triggerConfig (jsonb), delayValue (integer), delayUnit (varchar 50), actionType (actionTypeEnum notNull), actionConfig (jsonb), emailTemplateId (varchar 255), enabled (boolean default true notNull), lastRunAt (timestamp withTimezone), createdAt (timestamp withTimezone defaultNow notNull). Indexes: shop_id, enabled.

    TABLE: `messageLogs` — columns: id (uuid PK defaultRandom), shopId (varchar 255 notNull), customerId (uuid FK → customers.id), automationId (uuid FK → automations.id), channel (messageChannelEnum notNull), subject (varchar 500), status (messageStatusEnum notNull), sentAt (timestamp withTimezone), openedAt (timestamp withTimezone), clickedAt (timestamp withTimezone), createdAt (timestamp withTimezone defaultNow notNull). Indexes: shop_id, customer_id, automation_id, status.

    Use exact import from 'drizzle-orm/pg-core': { pgTable, pgEnum, uuid, varchar, text, numeric, integer, jsonb, boolean, timestamp, index }.

    ---

    Create `src/lib/db/index.ts`:
    ```typescript
    import { drizzle } from 'drizzle-orm/postgres-js'
    import postgres from 'postgres'
    import * as schema from './schema'
    import { env } from '@/lib/env'  // triggers validation on first db import

    // CRITICAL: prepare: false required for Supabase Transaction mode pooler (port 6543)
    // Without this: "prepared statements are not supported" errors under load
    const client = postgres(env.DATABASE_URL, { prepare: false })

    export const db = drizzle(client, { schema })
    export type DB = typeof db
    ```

    Create `src/lib/db/queries.ts` as an empty module with a comment:
    ```typescript
    // Reusable query functions — populated in later phases
    export {}
    ```

    Create `drizzle.config.ts` at project root:
    ```typescript
    import 'dotenv/config'
    import { defineConfig } from 'drizzle-kit'

    export default defineConfig({
      dialect: 'postgresql',
      schema: './src/lib/db/schema.ts',
      out: './drizzle',
      dbCredentials: {
        url: process.env.DATABASE_URL!,
      },
      verbose: true,
      strict: true,
    })
    ```

    NOTE: `@/lib/env` does not exist yet (created in plan 01-02). The db/index.ts file can be written with the import — it will resolve once env.ts exists. Do NOT skip the import or use process.env.DATABASE_URL directly in db/index.ts.
  </action>
  <verify>
    Run: `npx tsc --noEmit 2>&1 | head -20`
    Expected: No errors in schema.ts, db/index.ts, drizzle.config.ts (errors about missing @/lib/env are acceptable at this stage — the file doesn't exist yet).

    Confirm schema exports: `grep -c "^export const" src/lib/db/schema.ts`
    Expected: 10 (6 enums + 4 tables)
  </verify>
  <done>
    schema.ts exports 6 enums and 4 tables. db/index.ts references postgres client with prepare: false. drizzle.config.ts points to ./src/lib/db/schema.ts with out: './drizzle'. queries.ts exists as empty module.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate migration SQL from schema</name>
  <files>
    drizzle/
  </files>
  <action>
    Run drizzle-kit generate to produce migration SQL from the schema:
    ```bash
    npx drizzle-kit generate
    ```

    NOTE: drizzle-kit generate reads schema.ts and produces SQL — it does NOT need a live DB connection. If DATABASE_URL is not set in .env.local, drizzle.config.ts will throw. In that case, run with a dummy URL:
    ```bash
    DATABASE_URL=postgresql://localhost/dummy npx drizzle-kit generate
    ```

    After generation, open the generated .sql file in ./drizzle/ and verify it contains:
    1. `CREATE TYPE "customer_segment"` — before CREATE TABLE customers
    2. `CREATE TYPE "trigger_type"` — before CREATE TABLE automations
    3. `CREATE TYPE "action_type"` — before CREATE TABLE automations
    4. `CREATE TYPE "message_channel"` — before CREATE TABLE message_logs
    5. `CREATE TYPE "message_status"` — before CREATE TABLE message_logs
    6. `CREATE TYPE "financial_status"` — before CREATE TABLE orders
    7. `CREATE TABLE "customers"` with segment column referencing "customer_segment"
    8. `CREATE TABLE "orders"` with financial_status column
    9. `CREATE TABLE "automations"` with trigger_type and action_type columns
    10. `CREATE TABLE "message_logs"` with channel and status columns

    If any CREATE TYPE is missing, the corresponding pgEnum is not exported from schema.ts — fix the export.

    The generated migration file should be committed to git (it is the source of truth for schema version).
  </action>
  <verify>
    Run: `ls drizzle/*.sql 2>/dev/null | head -5`
    Expected: At least one .sql file exists.

    Run: `grep -c "CREATE TYPE" drizzle/*.sql`
    Expected: 6 (one per enum).

    Run: `grep "CREATE TABLE" drizzle/*.sql`
    Expected: 4 CREATE TABLE statements (customers, orders, automations, message_logs).
  </verify>
  <done>
    The ./drizzle/ directory contains at least one .sql migration file. The SQL file has 6 CREATE TYPE statements (one per enum) and 4 CREATE TABLE statements. The generated file is git-tracked.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "^export const" src/lib/db/schema.ts` returns 10
2. `grep "prepare: false" src/lib/db/index.ts` finds the line
3. `grep -c "CREATE TYPE" drizzle/*.sql` returns 6
4. `grep -c "CREATE TABLE" drizzle/*.sql` returns 4
5. `cat drizzle.config.ts` shows `out: './drizzle'` and `schema: './src/lib/db/schema.ts'`
</verification>

<success_criteria>
- schema.ts exists with 6 exported enums and 4 exported tables
- db/index.ts uses postgres client with { prepare: false } and imports env
- drizzle.config.ts is at project root pointing to schema with output to ./drizzle
- drizzle/ directory contains generated SQL with all 6 CREATE TYPE + 4 CREATE TABLE statements
- queries.ts exists as empty placeholder module
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md` with:
- What was built (files created, key decisions)
- Schema highlights (tables, enum values, index count)
- Migration status (generated vs applied)
- Any deviations from the plan
</output>
