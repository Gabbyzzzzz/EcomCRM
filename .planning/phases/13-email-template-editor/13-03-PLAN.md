---
phase: 13-email-template-editor
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - scripts/seed-preset-templates.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running `npm run seed:templates` inserts 5 preset templates into the email_templates table with is_preset = true"
    - "Each preset has a full Unlayer Design JSON object that opens correctly in the Unlayer editor"
    - "Re-running the seed script is idempotent — it does not create duplicate presets"
    - "All 5 presets appear on the /emails page with the Preset badge"
  artifacts:
    - path: "scripts/seed-preset-templates.ts"
      provides: "One-time seeder inserting 5 preset Unlayer templates"
      min_lines: 80
  key_links:
    - from: "scripts/seed-preset-templates.ts"
      to: "src/lib/db/schema.ts"
      via: "emailTemplates table import"
      pattern: "emailTemplates"
    - from: "scripts/seed-preset-templates.ts"
      to: "src/lib/db/index.ts"
      via: "db instance import"
      pattern: "from.*lib/db"
---

<objective>
Create and seed 5 preset Unlayer email templates (Welcome, Abandoned Cart, Repurchase, Win-back, VIP) as `is_preset = true` rows in the `email_templates` table.

Purpose: Merchants start with 5 ready-to-customize templates instead of an empty library. Each preset is a valid Unlayer Design JSON that opens in the editor for drag-and-drop customization.
Output: `scripts/seed-preset-templates.ts` with realistic Unlayer design JSON for each preset, plus `npm run seed:templates` script in package.json.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-email-template-editor/13-RESEARCH.md
@.planning/phases/13-email-template-editor/13-01-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/db/index.ts
@src/lib/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preset seed script with 5 Unlayer Design JSON templates</name>
  <files>scripts/seed-preset-templates.ts</files>
  <action>
Create `scripts/seed-preset-templates.ts` — a standalone TypeScript script that upserts 5 preset templates into the `email_templates` table using `onConflictDoNothing()`.

**Script structure:**

```typescript
import 'dotenv/config'
import { db } from '../src/lib/db'
import { emailTemplates } from '../src/lib/db/schema'
```

**shopId derivation** (matches the pattern used throughout the project):
```typescript
const shopUrl = process.env.SHOPIFY_STORE_URL ?? ''
const shopId = new URL(shopUrl).hostname
```

**Unlayer Design JSON format** — each preset uses Unlayer's native JSON format with `schemaVersion: 12`, `counters`, and `body.rows`. Every row has `cells`, `columns`, and each column has `contents`. Each content block has a `type` (`text`, `button`, `image`, `divider`) and a `values` object.

Build 5 complete preset design JSON objects. Each must be a valid object that `unlayer.loadDesign()` can accept. Use this row/column structure:

```typescript
// Helper: creates a single-column layout row with given content blocks
function row(id: string, contents: object[], bgColor = '') {
  return {
    id,
    cells: [1],
    columns: [{
      id: `${id}-col`,
      contents,
      values: {
        backgroundColor: bgColor,
        padding: '20px',
        border: {},
        _meta: { htmlID: `${id}-col`, htmlClassNames: 'u_column' },
      },
    }],
    values: {
      displayCondition: null,
      columns: false,
      backgroundColor: bgColor,
      columnsBackgroundColor: '',
      backgroundImage: { url: '', fullWidth: true, repeat: 'no-repeat', size: 'custom', position: 'center' },
      padding: '0px',
      hideDesktop: false,
      _meta: { htmlID: id, htmlClassNames: 'u_row' },
      selectable: true,
      draggable: true,
      duplicatable: true,
      deletable: true,
      hideable: true,
    },
  }
}
```

**Content block helpers:**

```typescript
function headingBlock(id: string, text: string, fontSize = '28px', color = '#333333') {
  return {
    id,
    type: 'heading',
    values: {
      containerPadding: '10px',
      anchor: '',
      headingType: 'h1',
      fontWeight: 700,
      fontSize,
      color,
      lineHeight: '140%',
      linkStyle: { inherit: true, linkColor: '#0000ee', linkHoverColor: '#0000ee', linkUnderline: true, linkHoverUnderline: true },
      hideDesktop: false,
      displayCondition: null,
      _meta: { htmlID: id, htmlClassNames: 'u_content_heading' },
      selectable: true,
      draggable: true,
      duplicatable: true,
      deletable: true,
      hideable: true,
      text: `<h1 style="margin: 0; line-height: 140%; text-align: center; word-wrap: break-word;">${text}</h1>`,
    },
  }
}

function textBlock(id: string, text: string, color = '#555555') {
  return {
    id,
    type: 'text',
    values: {
      containerPadding: '10px',
      anchor: '',
      fontSize: '14px',
      color,
      lineHeight: '160%',
      linkStyle: { inherit: true, linkColor: '#0000ee', linkHoverColor: '#0000ee', linkUnderline: true, linkHoverUnderline: true },
      hideDesktop: false,
      displayCondition: null,
      _meta: { htmlID: id, htmlClassNames: 'u_content_text' },
      selectable: true,
      draggable: true,
      duplicatable: true,
      deletable: true,
      hideable: true,
      text: `<p style="margin: 0; text-align: center; word-wrap: break-word;">${text}</p>`,
    },
  }
}

function buttonBlock(id: string, label: string, href = '#', bgColor = '#3B82F6') {
  return {
    id,
    type: 'button',
    values: {
      containerPadding: '20px',
      anchor: '',
      href: { name: 'web', values: { href, target: '_blank' } },
      buttonColors: { color: '#FFFFFF', backgroundColor: bgColor, hoverColor: '#FFFFFF', hoverBackgroundColor: bgColor },
      size: { autoWidth: true, width: '100%' },
      fontWeight: 700,
      fontSize: '14px',
      textAlign: 'center',
      lineHeight: '120%',
      padding: '12px 30px',
      border: {},
      borderRadius: '4px',
      hideDesktop: false,
      displayCondition: null,
      _meta: { htmlID: id, htmlClassNames: 'u_content_button' },
      selectable: true,
      draggable: true,
      duplicatable: true,
      deletable: true,
      hideable: true,
      text: `<span style="word-break: break-word; line-height: 168%;">${label}</span>`,
      calculatedWidth: 152,
      calculatedHeight: 43,
    },
  }
}

function dividerBlock(id: string) {
  return {
    id,
    type: 'divider',
    values: {
      width: '100%',
      border: { borderTopWidth: '1px', borderTopStyle: 'solid', borderTopColor: '#EEEEEE' },
      textAlign: 'center',
      containerPadding: '10px',
      anchor: '',
      hideDesktop: false,
      displayCondition: null,
      _meta: { htmlID: id, htmlClassNames: 'u_content_divider' },
      selectable: true,
      draggable: true,
      duplicatable: true,
      deletable: true,
      hideable: true,
    },
  }
}
```

**Body wrapper** — each design needs a `body` object wrapping the rows:
```typescript
function makeDesign(id: string, rows: object[], bgColor = '#F4F4F4') {
  return {
    schemaVersion: 12,
    counters: {
      u_row: rows.length,
      u_column: rows.length,
      u_content_text: 2,
      u_content_image: 1,
      u_content_button: 1,
      u_content_heading: 1,
      u_content_divider: 1,
    },
    body: {
      id,
      rows,
      headers: [],
      footers: [],
      values: {
        textColor: '#000000',
        backgroundColor: bgColor,
        backgroundImage: { url: '', fullWidth: true, repeat: 'no-repeat', size: 'custom', position: 'center' },
        preheaderText: '',
        linkStyle: { body: true, linkColor: '#0000ee', linkHoverColor: '#0000ee', linkUnderline: true, linkHoverUnderline: true },
        fontFamily: { label: 'Arial', value: 'arial,helvetica,sans-serif' },
        _meta: { htmlID: 'u_body', htmlClassNames: 'u_body' },
      },
    },
  }
}
```

**Define 5 preset designs using the helpers above:**

1. **Welcome** (`name: 'Welcome'`): Header row (brand blue `#1E40AF` bg, white heading "Welcome to the Family!"), body row (text "Thank you for joining us. We're thrilled to have you.", button "Shop Now" in blue), footer row (text "You're receiving this because you opted in. Unsubscribe.").

2. **Abandoned Cart** (`name: 'Abandoned Cart'`): Header row (amber `#F59E0B` bg, white heading "You Left Something Behind"), body row (text "Your cart is waiting! Complete your purchase before items sell out.", button "Return to Cart" in amber `#F59E0B`), footer row (unsubscribe text).

3. **Repurchase** (`name: 'Repurchase'`): Header row (green `#10B981` bg, white heading "Time to Stock Up?"), body row (text "It's been a while since your last order. Your favorites are still available!", button "Shop Again" in green `#10B981`), footer row (unsubscribe text).

4. **Win-back** (`name: 'Win-back'`): Header row (purple `#8B5CF6` bg, white heading "We Miss You!"), body row (text "It's been a while. Here's an exclusive offer to welcome you back: use code WINBACK15 for 15% off.", button "Claim Your Discount" in purple `#8B5CF6`), footer row (unsubscribe text).

5. **VIP** (`name: 'VIP'`): Header row (dark gold `#B45309` bg, white heading "You're a VIP ✦"), body row (text "As one of our most valued customers, you get exclusive early access to new arrivals and special rewards.", button "Shop the VIP Collection" in gold `#B45309`), footer row (unsubscribe text).

**Seeding logic:**

```typescript
const PRESETS = [
  { name: 'Welcome', design: WELCOME_DESIGN },
  { name: 'Abandoned Cart', design: ABANDONED_CART_DESIGN },
  { name: 'Repurchase', design: REPURCHASE_DESIGN },
  { name: 'Win-back', design: WINBACK_DESIGN },
  { name: 'VIP', design: VIP_DESIGN },
]

async function main() {
  console.log(`Seeding preset templates for shop: ${shopId}`)

  for (const preset of PRESETS) {
    const result = await db
      .insert(emailTemplates)
      .values({
        shopId,
        name: preset.name,
        designJson: preset.design,
        html: null,
        isPreset: true,
      })
      .onConflictDoNothing()
    console.log(`  [${preset.name}] seeded (or already existed)`)
  }

  console.log('Done! Run the app and visit /emails to see the presets.')
  process.exit(0)
}

main().catch((err) => {
  console.error('Seed failed:', err)
  process.exit(1)
})
```

**Important notes:**
- The `onConflictDoNothing()` call uses Drizzle's conflict mechanism. Since the `email_templates` table has no unique constraint on `(shopId, name)` by default (only the PK is unique), duplicate names CAN be inserted on re-runs. To make seeding idempotent, either: (a) add a unique index on `(shop_id, name, is_preset)` in the schema, or (b) check for existing presets before inserting. Use option (b): query existing preset names first, then only insert missing ones:

```typescript
async function main() {
  const existing = await db
    .select({ name: emailTemplates.name })
    .from(emailTemplates)
    .where(and(eq(emailTemplates.shopId, shopId), eq(emailTemplates.isPreset, true)))

  const existingNames = new Set(existing.map((r) => r.name))

  for (const preset of PRESETS) {
    if (existingNames.has(preset.name)) {
      console.log(`  [${preset.name}] already exists, skipping`)
      continue
    }
    await db.insert(emailTemplates).values({
      shopId,
      name: preset.name,
      designJson: preset.design,
      html: null,
      isPreset: true,
    })
    console.log(`  [${preset.name}] inserted`)
  }

  console.log('Done!')
  process.exit(0)
}
```

Import `eq`, `and` from `drizzle-orm` at the top.
  </action>
  <verify>
- File `scripts/seed-preset-templates.ts` exists and TypeScript compiles: `npx tsc --noEmit` passes
- Script imports are correct: `db` from `../src/lib/db`, `emailTemplates` from `../src/lib/db/schema`
- Each of the 5 preset objects (`WELCOME_DESIGN`, etc.) has `schemaVersion: 12` and a `body.rows` array with at least 3 rows
  </verify>
  <done>
- `scripts/seed-preset-templates.ts` exists with 5 complete Unlayer Design JSON objects
- Each design has heading, text, button, and footer rows using Unlayer's native JSON format
- Seeding is idempotent: running twice does not create duplicates
  </done>
</task>

<task type="auto">
  <name>Task 2: Add seed:templates npm script and run the seeder</name>
  <files>package.json</files>
  <action>
1. **Add `seed:templates` npm script to `package.json`**:

In the `"scripts"` section of `package.json`, add:
```json
"seed:templates": "npx ts-node --project tsconfig.json -e \"require('dotenv/config')\" scripts/seed-preset-templates.ts"
```

However, `ts-node` may not be installed. Use `tsx` instead since the project uses Next.js 14 which works well with `tsx`. Check if `tsx` is available; if not, use the `--loader ts-node/esm` or `dotenv` require approach. The safest approach for this project (which uses CommonJS-compatible TypeScript via Next.js) is:

```json
"seed:templates": "npx tsx --tsconfig tsconfig.json scripts/seed-preset-templates.ts"
```

`tsx` is a zero-config TypeScript executor that handles `dotenv/config` imports correctly.

2. **Run the seeder** to confirm it works:
```bash
npm run seed:templates
```

Expected output:
```
Seeding preset templates for shop: 66pqxy-de.myshopify.com
  [Welcome] inserted
  [Abandoned Cart] inserted
  [Repurchase] inserted
  [Win-back] inserted
  [VIP] inserted
Done!
```

3. **Verify in the database** that 5 rows now exist with `is_preset = true`:
- Check by visiting `http://localhost:3000/emails` — 5 template cards should appear, each with a "Preset" badge.
- Alternatively, check via the API: `curl http://localhost:3000/api/email-templates` and count rows with `"isPreset": true`.

4. **Verify idempotency** by running `npm run seed:templates` a second time — all 5 presets should show "already exists, skipping" and the `/emails` page should still show exactly 5 preset cards (no duplicates).
  </action>
  <verify>
- `cat package.json` shows `"seed:templates"` in the scripts section
- `npm run seed:templates` exits with code 0 and prints all 5 preset names
- `curl http://localhost:3000/api/email-templates | node -e "const d=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')); console.log(d.filter(t=>t.isPreset).length)"` outputs `5`
- Running `npm run seed:templates` a second time shows "already exists, skipping" for all 5 — no new rows created
  </verify>
  <done>
- `package.json` has `seed:templates` script using `tsx`
- 5 preset templates exist in the database with `is_preset = true`
- `/emails` page shows 5 cards each with "Preset" badge
- Script is idempotent: safe to run multiple times
  </done>
</task>

</tasks>

<verification>
1. `scripts/seed-preset-templates.ts` exists and imports from `../src/lib/db` and `../src/lib/db/schema`.
2. `npx tsc --noEmit` passes with no errors from the seed script (check tsconfig includes scripts/ or use the `--skipLibCheck` flag if needed).
3. `npm run seed:templates` exits with code 0 and inserts 5 rows.
4. Visiting `/emails` shows 5 preset template cards each with a "Preset" badge.
5. Each preset card's "Edit" button opens the Unlayer editor with the pre-authored design loaded (visible drag-and-drop structure, not blank).
6. Running the seed script a second time produces "already exists, skipping" for all 5 — database still has exactly 5 preset rows.
</verification>

<success_criteria>
- 5 preset templates exist in the email_templates table with is_preset = true
- Each preset opens in the Unlayer editor with a pre-designed layout (heading, body text, CTA button, footer)
- `npm run seed:templates` is idempotent — safe to run multiple times without creating duplicates
- All 5 appear on /emails page with the Preset badge visible
</success_criteria>

<output>
After completion, create `.planning/phases/13-email-template-editor/13-03-SUMMARY.md`
</output>
