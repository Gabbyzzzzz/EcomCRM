---
phase: 07-ai-insights
plan: 02
type: execute
wave: 1
depends_on: ["07-01"]
files_modified:
  - src/app/api/automations/[id]/generate-copy/route.ts
  - src/app/(dashboard)/automations/[id]/page.tsx
  - src/components/email-copy-generator.tsx
  - src/app/(dashboard)/automations/page.tsx
autonomous: false

must_haves:
  truths:
    - "Clicking an automation row navigates to a detail page showing the automation's configuration"
    - "The automation detail page has a 'Generate Suggestions' button for AI email copy"
    - "Clicking 'Generate Suggestions' produces 3 AI-written subject line and body copy options"
    - "Each suggestion can be viewed -- the user can accept or discard suggestions"
    - "If the AI call fails, the page shows an error message without crashing"
  artifacts:
    - path: "src/app/api/automations/[id]/generate-copy/route.ts"
      provides: "POST endpoint that calls generateEmailCopy and returns suggestions"
      exports: ["POST"]
    - path: "src/app/(dashboard)/automations/[id]/page.tsx"
      provides: "Automation detail page with configuration display and AI copy generation"
      contains: "EmailCopyGenerator"
    - path: "src/components/email-copy-generator.tsx"
      provides: "Client component with Generate Suggestions button, displays AI-generated copy options"
      contains: "use client"
  key_links:
    - from: "src/components/email-copy-generator.tsx"
      to: "/api/automations/[id]/generate-copy"
      via: "fetch on button click"
      pattern: "fetch.*api/automations.*generate-copy"
    - from: "src/app/api/automations/[id]/generate-copy/route.ts"
      to: "src/lib/ai/insights.ts"
      via: "generateEmailCopy call"
      pattern: "generateEmailCopy"
    - from: "src/app/(dashboard)/automations/[id]/page.tsx"
      to: "src/lib/db/queries.ts"
      via: "automation query by id"
      pattern: "automations.*eq.*id"
    - from: "src/app/(dashboard)/automations/page.tsx"
      to: "src/app/(dashboard)/automations/[id]/page.tsx"
      via: "Link href on automation row"
      pattern: "href.*automations/"
---

<objective>
Create the automation detail/editor page with AI email copy generation capability.

Purpose: AI-02 requirement -- on the automation template editor, clicking "Generate suggestions" produces AI-written subject line and body copy options that can be accepted or discarded before saving. Since no automation detail page exists yet, this plan creates one showing the automation's configuration and embedding the AI copy generator.

Output: Automation detail page at `/automations/[id]`, API endpoint for copy generation, client component for displaying suggestions, and updated automation list page with clickable rows.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ai-insights/07-01-SUMMARY.md
@src/lib/ai/insights.ts
@src/lib/db/queries.ts
@src/lib/db/schema.ts
@src/app/(dashboard)/automations/page.tsx
@src/lib/automation/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Email copy generation API and automation detail page</name>
  <files>src/app/api/automations/[id]/generate-copy/route.ts, src/app/(dashboard)/automations/[id]/page.tsx, src/components/email-copy-generator.tsx, src/app/(dashboard)/automations/page.tsx</files>
  <action>
**Create `src/app/api/automations/[id]/generate-copy/route.ts`:**

1. Import `env` from `@/lib/env`, `generateEmailCopy` from `@/lib/ai/insights`, `db` from `@/lib/db`, `automations` from `@/lib/db/schema`, `eq` and `and` from `drizzle-orm`.
2. Export async function POST with request and `{ params: Promise<{ id: string }> }`.
3. Derive shopId from `new URL(env.SHOPIFY_STORE_URL).hostname`.
4. Fetch the automation by id: `db.select().from(automations).where(and(eq(automations.id, id), eq(automations.shopId, shopId))).limit(1)`. If not found, return 404.
5. Extract templateType from `automation.emailTemplateId ?? 'welcome'`, segmentTarget from `(automation.triggerConfig as { toSegment?: string } | null)?.toSegment ?? automation.triggerType`, and automationName from `automation.name`.
6. Call `generateEmailCopy({ templateType, segmentTarget, storeName: env.RESEND_FROM_NAME ?? 'EcomCRM', automationName })`.
7. Return the suggestions as JSON with 200.
8. On error, return 500 with `{ error: 'Failed to generate copy suggestions' }`.

**Create `src/components/email-copy-generator.tsx`:**

1. Add `'use client'` directive.
2. Import `useState` from React.
3. Props: `{ automationId: string, emailTemplateId: string | null }`.
4. State: `suggestions` (array of `{ subjectLine: string, bodyPreview: string }`), `loading` (boolean), `error` (string | null).
5. Function `handleGenerate`:
   - Set loading true, clear error and existing suggestions.
   - Fetch `POST /api/automations/${automationId}/generate-copy`.
   - Parse JSON, set suggestions from response.
   - On error, set error message.
   - Set loading false in finally.
6. Render:
   - A "Generate Suggestions" button (use shadcn Button component from `@/components/ui/button` if available, otherwise a styled button). Disabled while loading. Show a spinner text ("Generating...") when loading.
   - If emailTemplateId is null, show muted text "This automation does not use email templates" and disable the button.
   - Below the button, if suggestions exist, render them as a list of cards:
     - Each card shows the subject line in bold and body preview below in muted text.
     - Each card has a subtle border and padding.
   - If error, show error text in red/muted.
   - Add a note: "These are AI-generated suggestions. Review and customize before using." in text-xs text-muted-foreground.

**Create `src/app/(dashboard)/automations/[id]/page.tsx`:**

1. Server Component. Import `env`, `db`, `automations` schema, `eq`, `and` from drizzle-orm.
2. Import `notFound` from next/navigation, `Link` from next/link.
3. Import `EmailCopyGenerator` from `@/components/email-copy-generator`.
4. Fetch automation by id and shopId. If not found, call `notFound()`.
5. Render:
   - Back link to `/automations`.
   - Heading: automation name.
   - Status badge: Active/Disabled (same pattern as list page).
   - Configuration section (rounded-lg border bg-card p-6):
     - Trigger: human-readable label (reuse the triggerLabel logic from automations/page.tsx -- extract or duplicate the helper).
     - Delay: `{delayValue} {delayUnit}` or "No delay".
     - Action: actionType displayed human-readably.
     - Email Template: emailTemplateId or "N/A".
     - Last Run: date or "Never".
   - AI Email Copy Generation section (rounded-lg border bg-card p-6):
     - Heading: "AI Email Copy Generator"
     - Subheading: "Generate subject line and body copy suggestions using AI"
     - Embed `<EmailCopyGenerator automationId={automation.id} emailTemplateId={automation.emailTemplateId} />`

**Update `src/app/(dashboard)/automations/page.tsx`:**

1. Make each automation row clickable by wrapping the Flow Name cell content in a `Link` to `/automations/${automation.id}`.
2. Import `Link` from `next/link`.
3. Add the link with `className="hover:underline text-primary"` styling on the name text.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- succeeds. Navigate to `/automations` and click an automation name to reach `/automations/[id]` detail page. The "Generate Suggestions" button should be visible.
  </verify>
  <done>
Automation detail page exists at `/automations/[id]` showing configuration and AI copy generator. Clicking "Generate Suggestions" calls the API, which invokes Claude to produce 3 subject/body suggestions. Automation list page has clickable names linking to detail pages.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 7 AI Insights integration</name>
  <files>none</files>
  <action>
Human verification step. All automated tasks across plans 07-01 and 07-02 are complete. Verify the full Phase 7 AI Insights integration works end-to-end:
1. Customer AI Insight narrative on the 360 profile page
2. Email copy generation on the automation detail page
  </action>
  <verify>
1. Start the dev server: `npm run dev`
2. Navigate to any customer 360 profile (e.g., `/customers/[some-uuid]`)
   - Verify: AI Insight card appears below the info cards grid
   - Verify: Loading skeleton shows briefly, then insight text appears
   - Verify: Insight mentions the customer's segment and recommends an action
   - Verify: "Regenerate" button produces a new insight
   - If ANTHROPIC_API_KEY is not set: verify fallback message shows gracefully
3. Navigate to `/automations`
   - Verify: Automation names are clickable links
4. Click an automation name (e.g., "Welcome Flow")
   - Verify: Detail page shows automation configuration (trigger, delay, action, template)
   - Verify: Back link returns to automation list
5. Click "Generate Suggestions"
   - Verify: Loading state shows
   - Verify: 3 subject line + body preview cards appear
   - Verify: Note about AI-generated content is visible
  </verify>
  <done>
Both AI-01 (customer insight narrative) and AI-02 (email copy generation) verified working end-to-end. Phase 7 complete.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors across all new files
2. `npm run build` succeeds
3. Automation list page has clickable names linking to `/automations/[id]`
4. Automation detail page displays configuration and AI copy generator
5. POST `/api/automations/[id]/generate-copy` returns 3 suggestions
6. Human verification confirms both AI features work end-to-end
</verification>

<success_criteria>
- Automation detail page at `/automations/[id]` renders configuration and embeds AI copy generator
- Clicking "Generate Suggestions" produces 3 subject line + body preview options via Claude API
- Suggestions are displayed as reviewable cards -- user can see them and choose to use or discard
- Automation list page names link to detail pages
- Both AI-01 (customer insight) and AI-02 (copy generation) are verified working end-to-end
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-insights/07-02-SUMMARY.md`
</output>
