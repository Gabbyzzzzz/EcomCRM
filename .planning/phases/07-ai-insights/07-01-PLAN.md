---
phase: 07-ai-insights
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/insights.ts
  - src/app/api/customers/[id]/insights/route.ts
  - src/app/(dashboard)/customers/[id]/page.tsx
  - src/components/customer-ai-insight.tsx
autonomous: true

must_haves:
  truths:
    - "Opening a customer 360 profile displays a plain-language AI insight narrative using live RFM scores and order data"
    - "The insight narrative describes the customer's segment, purchasing pattern, recency, and a recommended action"
    - "The insight loads asynchronously after the page renders — the profile is never blocked by AI latency"
    - "If the AI call fails, the profile still renders normally with a fallback message"
  artifacts:
    - path: "src/lib/ai/insights.ts"
      provides: "generateCustomerInsight function that calls Claude API with customer data"
      exports: ["generateCustomerInsight"]
    - path: "src/app/api/customers/[id]/insights/route.ts"
      provides: "GET endpoint returning AI-generated insight for a customer"
      exports: ["GET"]
    - path: "src/components/customer-ai-insight.tsx"
      provides: "Client component that fetches and displays AI insight with loading state"
      contains: "use client"
    - path: "src/app/(dashboard)/customers/[id]/page.tsx"
      provides: "Customer profile page with AI insight section added"
      contains: "CustomerAiInsight"
  key_links:
    - from: "src/components/customer-ai-insight.tsx"
      to: "/api/customers/[id]/insights"
      via: "fetch in useEffect"
      pattern: "fetch.*api/customers.*insights"
    - from: "src/app/api/customers/[id]/insights/route.ts"
      to: "src/lib/ai/insights.ts"
      via: "generateCustomerInsight call"
      pattern: "generateCustomerInsight"
    - from: "src/lib/ai/insights.ts"
      to: "@anthropic-ai/sdk"
      via: "Anthropic client"
      pattern: "new Anthropic"
---

<objective>
Create the AI insights library and integrate per-customer insight narratives into the customer 360 profile page.

Purpose: AI-01 requirement — every customer profile should show a plain-language insight narrative generated by Claude, describing the customer's segment, purchasing behavior, and a recommended next action (e.g., "Customer is at risk: last ordered 90 days ago, down from monthly cadence. Suggest win-back offer.").

Output: `src/lib/ai/insights.ts` with Claude API wrapper, API route for insight generation, client component for async display, and updated customer profile page.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/env.ts
@src/lib/db/queries.ts
@src/lib/db/schema.ts
@src/app/(dashboard)/customers/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI insights library and API endpoint</name>
  <files>src/lib/ai/insights.ts, src/app/api/customers/[id]/insights/route.ts</files>
  <action>
Create `src/lib/ai/insights.ts`:

1. Import Anthropic from `@anthropic-ai/sdk` and `env` from `@/lib/env`.
2. Create a singleton Anthropic client: `new Anthropic({ apiKey: env.ANTHROPIC_API_KEY })`.
3. Define `CustomerInsightData` interface with the fields needed for the prompt:
   - name, email, segment, rfmR, rfmF, rfmM (all from customer row)
   - totalSpent (string), orderCount (number), avgOrderValue (string)
   - firstOrderAt (string ISO or null), lastOrderAt (string ISO or null)
   - daysSinceLastOrder (number or null)
4. Export `async function generateCustomerInsight(data: CustomerInsightData): Promise<string>`.
5. Inside, build a system prompt instructing Claude to act as a CRM analyst for a Shopify store. Tell it to produce a concise 2-4 sentence insight narrative that:
   - States the customer's current segment and what it means
   - Describes their purchasing pattern (frequency, recency, monetary value)
   - Recommends one specific action (e.g., "send win-back offer", "upsell to premium", "maintain VIP engagement")
   - Uses plain language a merchant would understand
6. Build the user message from the CustomerInsightData fields — include all RFM scores, segment, spending, order count, dates.
7. Call `anthropic.messages.create({ model: 'claude-sonnet-4-20250514', max_tokens: 300, system: systemPrompt, messages: [{ role: 'user', content: userMessage }] })`.
8. Extract the text content from the response: `response.content[0].type === 'text' ? response.content[0].text : ''`.
9. Wrap the entire function body in try/catch — on error, log and return a fallback string: "Unable to generate insight at this time."

Also export `async function generateEmailCopy(params: EmailCopyParams): Promise<EmailCopySuggestions>` for Plan 02 consumption:

1. Define `EmailCopyParams` interface: { templateType: string, segmentTarget: string, storeName: string, automationName: string }.
2. Define `EmailCopySuggestions` interface: { suggestions: Array<{ subjectLine: string, bodyPreview: string }> }.
3. Build a system prompt instructing Claude to generate 3 email subject line + body preview combinations for a specific email template type targeting a specific customer segment.
4. Instruct it to return valid JSON matching the EmailCopySuggestions shape. Use `response.content[0].text`, then JSON.parse it.
5. Wrap in try/catch — on error, return `{ suggestions: [] }`.

Create `src/app/api/customers/[id]/insights/route.ts`:

1. Import `env` from `@/lib/env`, `getCustomerProfile` from `@/lib/db/queries`, `generateCustomerInsight` from `@/lib/ai/insights`.
2. Export async function GET with request and params: `{ params: Promise<{ id: string }> }`.
3. Derive shopId from `new URL(env.SHOPIFY_STORE_URL).hostname`.
4. Fetch customer via `getCustomerProfile(shopId, id)`. If not found, return 404 JSON.
5. Compute daysSinceLastOrder: customer.lastOrderAt ? Math.floor((Date.now() - new Date(customer.lastOrderAt).getTime()) / 86400000) : null.
6. Build CustomerInsightData from the customer row.
7. Call `generateCustomerInsight(data)` and return `{ insight: string }` as JSON with 200.
8. On error, return 500 with `{ error: 'Failed to generate insight' }`.

Do NOT use `any` — type all parameters and return values explicitly.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in the new files. Verify the API route file exports GET.
  </verify>
  <done>
`src/lib/ai/insights.ts` exports generateCustomerInsight and generateEmailCopy. `src/app/api/customers/[id]/insights/route.ts` exports GET handler that calls the insight function with customer data from DB.
  </done>
</task>

<task type="auto">
  <name>Task 2: Customer profile AI insight component integration</name>
  <files>src/components/customer-ai-insight.tsx, src/app/(dashboard)/customers/[id]/page.tsx</files>
  <action>
Create `src/components/customer-ai-insight.tsx`:

1. Add `'use client'` directive at top.
2. Import `useState`, `useEffect` from React.
3. Define props: `{ customerId: string }`.
4. Component renders an insight card with:
   - Header: "AI Insight" with a small sparkle/brain icon (use a simple SVG inline or unicode char like the lightbulb).
   - Loading state: a pulsing skeleton line (use `animate-pulse bg-muted rounded h-4 w-full` pattern, show 3 skeleton lines).
   - Loaded state: the insight text in `text-sm text-foreground leading-relaxed`.
   - Error state: muted text "Unable to generate insight at this time."
5. In useEffect (on mount), fetch `/api/customers/${customerId}/insights`.
6. Parse JSON response, set the insight text into state.
7. Handle fetch errors gracefully — set error state, never crash.
8. Add a "Regenerate" button (small, text-style) that re-triggers the fetch when clicked. Use `useState` for a `refreshKey` counter that increments on click, add it to the useEffect dependency array.

Update `src/app/(dashboard)/customers/[id]/page.tsx`:

1. Import `CustomerAiInsight` from `@/components/customer-ai-insight`.
2. Add the AI insight section AFTER the Info Cards Row grid and BEFORE the Tags Section.
3. Render it as:
```tsx
<div className="rounded-lg border bg-card p-6">
  <CustomerAiInsight customerId={id} />
</div>
```
4. This is a Client Component embedded in a Server Component — standard Next.js pattern. The profile page itself remains a Server Component; the insight loads client-side asynchronously.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Run `npm run build` to verify the page compiles. Visually: navigating to `/customers/[id]` should show a loading skeleton for the insight, then the AI-generated text (or error fallback if no ANTHROPIC_API_KEY).
  </verify>
  <done>
Customer 360 profile page at `/customers/[id]` displays an AI insight section that asynchronously fetches and renders a plain-language insight narrative. Loading shows skeleton. Errors show fallback text. Regenerate button allows re-fetching.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. `src/lib/ai/insights.ts` exports both `generateCustomerInsight` and `generateEmailCopy`
4. `src/app/api/customers/[id]/insights/route.ts` exports GET handler
5. `src/components/customer-ai-insight.tsx` is a client component with loading, loaded, and error states
6. Customer profile page renders the AI insight card between info cards and tags section
</verification>

<success_criteria>
- Opening `/customers/[id]` shows the AI insight card with loading skeleton, then insight text
- The insight describes the customer's segment, purchasing pattern, and a recommended action
- If the API call fails, the page still renders with a graceful fallback message
- Clicking "Regenerate" re-fetches a new insight
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-insights/07-01-SUMMARY.md`
</output>
