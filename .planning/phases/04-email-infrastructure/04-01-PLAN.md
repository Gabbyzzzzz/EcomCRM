---
phase: 04-email-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/env.ts
  - src/lib/email/send.ts
  - src/lib/email/unsubscribe.ts
  - src/lib/db/queries.ts
  - src/emails/welcome.tsx
  - src/emails/abandoned-cart.tsx
  - src/emails/repurchase.tsx
  - src/emails/winback.tsx
  - src/emails/vip.tsx
  - .env.local.example
autonomous: true

must_haves:
  truths:
    - "All 5 React Email templates render to valid HTML without errors"
    - "sendMarketingEmail() includes List-Unsubscribe and List-Unsubscribe-Post headers on every send"
    - "sendMarketingEmail() with the same idempotency key does not send a duplicate email"
    - "sendMarketingEmail() blocks sends when customer has marketing_opted_out = true"
    - "sendMarketingEmail() blocks sends when email address is in the suppression table"
    - "Blocked sends are logged to MessageLog with status 'suppressed'"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "marketing_opted_out column on customers, suppressions table, updated messageStatusEnum with 'suppressed' and 'failed'"
      contains: "marketingOptedOut"
    - path: "src/lib/email/send.ts"
      provides: "sendMarketingEmail function with Resend SDK, compliance headers, idempotency, suppression gate"
      exports: ["sendMarketingEmail"]
    - path: "src/lib/email/unsubscribe.ts"
      provides: "Token generation and verification for unsubscribe links"
      exports: ["generateUnsubscribeToken", "verifyUnsubscribeToken"]
    - path: "src/emails/welcome.tsx"
      provides: "Welcome email React Email template"
    - path: "src/emails/abandoned-cart.tsx"
      provides: "Abandoned cart email React Email template"
    - path: "src/emails/repurchase.tsx"
      provides: "Repurchase email React Email template"
    - path: "src/emails/winback.tsx"
      provides: "Win-back email React Email template"
    - path: "src/emails/vip.tsx"
      provides: "VIP email React Email template"
    - path: "src/lib/env.ts"
      provides: "RESEND_FROM_NAME, RESEND_FROM_EMAIL, RESEND_REPLY_TO env vars"
    - path: "src/lib/db/queries.ts"
      provides: "checkSuppression and insertSuppression query functions"
  key_links:
    - from: "src/lib/email/send.ts"
      to: "src/lib/db/queries.ts"
      via: "suppression + opt-out check before send"
      pattern: "checkSuppression|marketingOptedOut"
    - from: "src/lib/email/send.ts"
      to: "src/emails/*.tsx"
      via: "render() call to produce HTML from React Email component"
      pattern: "render.*Email"
    - from: "src/lib/email/send.ts"
      to: "resend"
      via: "Resend SDK emails.send() with idempotencyKey"
      pattern: "resend\\.emails\\.send"
    - from: "src/lib/email/send.ts"
      to: "src/lib/email/unsubscribe.ts"
      via: "generates unsubscribe URL for List-Unsubscribe header"
      pattern: "generateUnsubscribeToken"
---

<objective>
Create the 5 React Email templates, the Resend send wrapper with idempotency and compliance headers, the suppression/opt-out gate, and the unsubscribe token utility. This establishes the entire email sending infrastructure that Plan 02 builds the webhook/unsubscribe page on top of.

Purpose: Without a working send layer, no automation can dispatch emails. This plan creates everything needed to safely send a compliant marketing email.
Output: 5 email templates, send wrapper, schema extensions, unsubscribe token utility
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/db/schema.ts
@src/lib/db/queries.ts
@src/lib/env.ts
@src/inngest/functions.ts
@src/lib/shopify/client.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extensions + env vars + unsubscribe token utility</name>
  <files>
    src/lib/db/schema.ts
    src/lib/env.ts
    src/lib/email/unsubscribe.ts
    src/lib/db/queries.ts
    .env.local.example
  </files>
  <action>
**Schema changes in `src/lib/db/schema.ts`:**

1. Add `'suppressed'` and `'failed'` to the existing `messageStatusEnum` array (append after `'converted'`). These are new valid statuses for MessageLog.

2. Add `marketingOptedOut` column to the `customers` table:
   ```
   marketingOptedOut: boolean('marketing_opted_out').default(false).notNull()
   ```
   Place it after the `lifecycleStage` column.

3. Create a new `suppressionReasonEnum` pgEnum:
   ```
   export const suppressionReasonEnum = pgEnum('suppression_reason', ['hard_bounce', 'unsubscribe', 'manual'])
   ```

4. Create a new `suppressions` table:
   ```
   export const suppressions = pgTable('suppressions', {
     id: uuid('id').primaryKey().defaultRandom(),
     shopId: varchar('shop_id', { length: 255 }).notNull(),
     email: varchar('email', { length: 255 }).notNull(),
     reason: suppressionReasonEnum('reason').notNull(),
     createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
   }, (table) => [
     index('suppressions_shop_id_idx').on(table.shopId),
     uniqueIndex('suppressions_shop_email_unique').on(table.shopId, table.email),
   ])
   ```
   The unique index on (shopId, email) enables upsert-on-conflict for idempotent suppression inserts.

**Env var additions in `src/lib/env.ts`:**

Add three new optional env vars to the Zod schema. Use `.optional().default(...)` so existing deployments don't break:
- `RESEND_FROM_NAME`: `z.string().min(1).optional().default('EcomCRM')`
- `RESEND_FROM_EMAIL`: `z.string().min(1).optional().default('noreply@example.com')`
- `RESEND_REPLY_TO`: `z.string().optional()` (no default — if unset, reply-to is not included)
- `APP_URL`: `z.string().min(1).optional().default('http://localhost:3000')` (base URL for unsubscribe links)

**Unsubscribe token utility in `src/lib/email/unsubscribe.ts`:**

Create HMAC-based unsubscribe tokens. Uses SHOPIFY_CLIENT_SECRET as the signing key (already available in env, no new secret needed).

```typescript
import { createHmac } from 'crypto'
import { env } from '@/lib/env'

/**
 * Generate a signed unsubscribe token for a customer.
 * Token format: base64url(customerId:shopId:timestamp:hmac)
 * The HMAC prevents forged unsubscribe requests.
 */
export function generateUnsubscribeToken(customerId: string, shopId: string): string
export function verifyUnsubscribeToken(token: string): { customerId: string; shopId: string } | null
export function buildUnsubscribeUrl(customerId: string, shopId: string): string
```

The token should encode customerId + shopId, signed with HMAC-SHA256 using `env.SHOPIFY_CLIENT_SECRET`. Use base64url encoding (URL-safe). `buildUnsubscribeUrl` returns `${env.APP_URL}/unsubscribe?token=...`.

**Query additions in `src/lib/db/queries.ts`:**

Add these functions (import `suppressions` from schema):

1. `checkSuppression(shopId: string, email: string): Promise<boolean>` — Returns true if email is in the suppressions table for this shop.

2. `insertSuppression(shopId: string, email: string, reason: 'hard_bounce' | 'unsubscribe' | 'manual'): Promise<void>` — Inserts into suppressions table. Use `.onConflictDoNothing()` on the unique (shopId, email) index so duplicate calls are safe.

3. `removeSuppression(shopId: string, email: string): Promise<void>` — Deletes from suppressions table. Used for re-subscribe/undo unsubscribe.

4. `setMarketingOptedOut(shopId: string, customerInternalId: string, optedOut: boolean): Promise<void>` — Updates the `marketing_opted_out` column on the customer row.

5. `getCustomerByInternalId(shopId: string, customerInternalId: string)` — Returns the full customer row. Needed by the unsubscribe page and send wrapper.

6. `getCustomerByEmail(shopId: string, email: string)` — Returns the customer row by email. Needed by the Resend bounce webhook to look up the customer.

**Update `.env.local.example`:**

Add a new section for email sending config:
```
# ─── Email Sending (Resend) ───────────────────────────────────────
# From name displayed in recipient inbox
RESEND_FROM_NAME=Your Store Name
# Full sending address — use your verified marketing subdomain
RESEND_FROM_EMAIL=hello@marketing.your-store.com
# Reply-to address (optional — omit for noreply behavior)
RESEND_REPLY_TO=support@your-store.com
# Public base URL for unsubscribe links (no trailing slash)
APP_URL=https://your-app.vercel.app
```

Also add DNS setup documentation comment:
```
# ─── DNS Setup for Email Deliverability ───────────────────────────
# Add these DNS records to your domain before sending:
# 1. SPF (TXT): v=spf1 include:amazonses.com ~all
# 2. DKIM: Configured automatically by Resend when you verify your domain
# 3. DMARC (TXT): v=DMARC1; p=none; rua=mailto:dmarc@your-domain.com
# 4. Subdomain: Add marketing.your-domain.com as a verified domain in Resend
# See: https://resend.com/docs/dashboard/domains/introduction
```

**Generate migration SQL:**

Run `npx drizzle-kit generate` to produce the migration file for the new column and table.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes with no errors
    2. `npx drizzle-kit generate` produces a migration SQL file with ALTER TABLE customers ADD COLUMN marketing_opted_out, CREATE TYPE suppression_reason, CREATE TABLE suppressions, and ALTER TYPE message_status ADD VALUE 'suppressed', ADD VALUE 'failed'
    3. Import `{ generateUnsubscribeToken, verifyUnsubscribeToken }` from `@/lib/email/unsubscribe` compiles without error
    4. Import `{ checkSuppression, insertSuppression, removeSuppression, setMarketingOptedOut }` from `@/lib/db/queries` compiles without error
  </verify>
  <done>
    - customers table has marketing_opted_out boolean column (default false)
    - suppressions table exists with shopId, email, reason, unique (shopId, email) index
    - messageStatusEnum includes 'suppressed' and 'failed'
    - env.ts validates RESEND_FROM_NAME, RESEND_FROM_EMAIL, RESEND_REPLY_TO, APP_URL with safe defaults
    - Unsubscribe token utility generates and verifies HMAC-signed tokens
    - DB query functions for suppression CRUD and customer opt-out exist
    - .env.local.example documents all new env vars and DNS setup
    - Migration SQL generated
  </done>
</task>

<task type="auto">
  <name>Task 2: React Email templates + Resend send wrapper</name>
  <files>
    src/emails/welcome.tsx
    src/emails/abandoned-cart.tsx
    src/emails/repurchase.tsx
    src/emails/winback.tsx
    src/emails/vip.tsx
    src/lib/email/send.ts
  </files>
  <action>
**5 React Email templates:**

All templates use `@react-email/components` (already in package.json). Per locked decision: clean branded HTML, professional & neutral tone, mobile-responsive.

Each template receives props and renders branded HTML. Common structure:
- Import from `@react-email/components`: Html, Head, Preview, Body, Container, Section, Text, Button, Img, Hr
- Accept props: `{ storeName: string; customerName?: string; unsubscribeUrl: string; ... }` (additional props vary by template)
- Reserve a logo image URL slot via an `Img` component with `src` prop (merchant sets later)
- Include store name as text heading
- End with unsubscribe footer link pointing to `unsubscribeUrl`
- Use inline Tailwind-style CSS via React Email's style props for mobile responsiveness
- Max-width container (600px), centered, with padding

**Template-specific content:**

1. `welcome.tsx` — Props: `{ storeName, customerName, unsubscribeUrl }`. Subject preview: "Welcome to {storeName}". Body: greeting, brief value proposition, CTA button.

2. `abandoned-cart.tsx` — Props: `{ storeName, customerName, cartItems: Array<{ title: string; price: string; imageUrl?: string }>, cartUrl: string, unsubscribeUrl }`. Subject preview: "You left something behind". Body: cart item list with prices, CTA to complete purchase.

3. `repurchase.tsx` — Props: `{ storeName, customerName, lastOrderDate: string, productSuggestions?: Array<{ title: string; price: string; url: string }>, shopUrl: string, unsubscribeUrl }`. Subject preview: "Time to restock?". Body: reminder of last purchase, product suggestions if provided, CTA to shop.

4. `winback.tsx` — Props: `{ storeName, customerName, daysSinceLastOrder: number, incentive?: string, shopUrl: string, unsubscribeUrl }`. Subject preview: "We miss you, {customerName}". Body: we haven't seen you message, optional incentive/discount mention, CTA.

5. `vip.tsx` — Props: `{ storeName, customerName, totalSpent: string, orderCount: number, perks?: string[], shopUrl: string, unsubscribeUrl }`. Subject preview: "You're a VIP at {storeName}". Body: recognition of loyalty, stats, optional perks list, exclusive CTA.

All templates must be valid React Email components that export default. Use consistent color scheme: primary brand color `#2563eb` (blue-600), text `#1f2937` (gray-800), muted text `#6b7280` (gray-500), background `#f9fafb` (gray-50).

**Resend send wrapper in `src/lib/email/send.ts`:**

```typescript
import { Resend } from 'resend'
import { render } from '@react-email/render'
import { env } from '@/lib/env'
import { db } from '@/lib/db'
import { customers, messageLogs } from '@/lib/db/schema'
import { checkSuppression, getCustomerByInternalId } from '@/lib/db/queries'
import { buildUnsubscribeUrl } from '@/lib/email/unsubscribe'
import { eq, and } from 'drizzle-orm'
import type { ReactElement } from 'react'

const resend = new Resend(env.RESEND_API_KEY)

interface SendMarketingEmailParams {
  shopId: string
  customerInternalId: string  // UUID from customers table
  subject: string
  template: ReactElement      // React Email component already instantiated with props
  idempotencyKey: string      // Caller provides (e.g. `${automationId}-${customerId}-${triggeredAt}`)
  automationId?: string       // Optional FK to automations table
}

interface SendResult {
  sent: boolean
  reason?: 'suppressed_opted_out' | 'suppressed_bounced' | 'suppressed_no_email' | 'sent' | 'error'
  resendId?: string
}
```

**sendMarketingEmail logic:**

1. Look up the customer by `customerInternalId` and `shopId` using `getCustomerByInternalId`.
2. If customer has no email → log to MessageLog as 'suppressed', return `{ sent: false, reason: 'suppressed_no_email' }`.
3. If `customer.marketingOptedOut === true` → log to MessageLog as 'suppressed', return `{ sent: false, reason: 'suppressed_opted_out' }`.
4. Check `checkSuppression(shopId, customer.email)` → if true, log as 'suppressed', return `{ sent: false, reason: 'suppressed_bounced' }`.
5. Render the template to HTML string using `render(template)` from `@react-email/render`.
6. Build the unsubscribe URL using `buildUnsubscribeUrl(customerInternalId, shopId)`.
7. Call `resend.emails.send()` with:
   - `from`: `${env.RESEND_FROM_NAME} <${env.RESEND_FROM_EMAIL}>`
   - `to`: customer.email
   - `subject`: provided subject
   - `html`: rendered HTML
   - `replyTo`: `env.RESEND_REPLY_TO || undefined`
   - `headers`: `{ 'List-Unsubscribe': `<${unsubscribeUrl}>`, 'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click' }` (EMAIL-05 compliance)
   - `tags`: `[{ name: 'shop_id', value: shopId }]` (for Resend dashboard filtering)
   - Pass the `idempotencyKey` as Resend's `Idempotency-Key` header (check Resend SDK — may be a top-level option or require custom headers approach).

   **Important:** Resend SDK v6+ supports idempotency via the `idempotencyKey` option in `emails.send()`. Use: `resend.emails.send({ ... }, { idempotencyKey })`.

8. On success: insert into `messageLogs` with status `'sent'`, sentAt = now. Return `{ sent: true, reason: 'sent', resendId: data.id }`.
9. On error: insert into `messageLogs` with status `'failed'`. Log the error. Return `{ sent: false, reason: 'error' }`. Do NOT throw — email failures are non-fatal per architecture doc.

Export `sendMarketingEmail` as a named export.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes with no errors
    2. Each template file exports a default React component
    3. `src/lib/email/send.ts` exports `sendMarketingEmail`
    4. All imports resolve correctly (no missing modules)
    5. `npm run build` succeeds
  </verify>
  <done>
    - 5 React Email templates exist in src/emails/ with consistent branding, mobile-responsive layout, and unsubscribe footer
    - sendMarketingEmail checks marketing_opted_out, checks suppression table, renders template, sends via Resend with List-Unsubscribe + List-Unsubscribe-Post headers and idempotency key
    - Blocked sends logged to MessageLog as 'suppressed' (not thrown as errors)
    - All template props are typed (no `any`)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors across entire project
2. `npm run build` — Next.js build succeeds (templates compile, send module resolves)
3. Migration SQL file exists in drizzle/ with correct schema changes
4. All 5 template files exist and export default components
5. `sendMarketingEmail` function handles all suppression paths and returns structured results
</verification>

<success_criteria>
- EMAIL-05: List-Unsubscribe and List-Unsubscribe-Post headers present in sendMarketingEmail
- EMAIL-06: All 5 templates exist and render to HTML
- EMAIL-02: marketing_opted_out check gates all sends
- EMAIL-03 (partial): Suppression table and check exist (webhook wiring in Plan 02)
- EMAIL-01 (partial): marketing_opted_out column exists (webhook updates in Plan 02)
- Idempotency key passed through to Resend SDK
</success_criteria>

<output>
After completion, create `.planning/phases/04-email-infrastructure/04-01-SUMMARY.md`
</output>
