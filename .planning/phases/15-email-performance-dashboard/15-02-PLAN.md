---
phase: 15-email-performance-dashboard
plan: "02"
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/lib/db/queries.ts
  - src/components/email-performance-chart.tsx
  - src/app/(dashboard)/automations/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Automation detail page shows a line chart with sends, opens, and clicks over time (last 30 days)"
    - "Customer profile Message History shows status icons with timestamps (already exists from Phase 12-02, verified)"
  artifacts:
    - path: "src/lib/db/queries.ts"
      provides: "getAutomationEmailTimeSeries query function"
      exports: ["getAutomationEmailTimeSeries"]
    - path: "src/components/email-performance-chart.tsx"
      provides: "Recharts line chart component for email performance time series"
      contains: "EmailPerformanceChart"
    - path: "src/app/(dashboard)/automations/[id]/page.tsx"
      provides: "Time-series chart section on automation detail"
      contains: "EmailPerformanceChart"
  key_links:
    - from: "src/components/email-performance-chart.tsx"
      to: "recharts"
      via: "LineChart, Line import"
      pattern: "from 'recharts'"
    - from: "src/app/(dashboard)/automations/[id]/page.tsx"
      to: "src/components/email-performance-chart.tsx"
      via: "EmailPerformanceChart import"
      pattern: "EmailPerformanceChart"
    - from: "src/app/(dashboard)/automations/[id]/page.tsx"
      to: "src/lib/db/queries.ts"
      via: "getAutomationEmailTimeSeries import"
      pattern: "getAutomationEmailTimeSeries"
---

<objective>
Add a sends/opens/clicks time-series line chart to the automation detail page, and verify the customer profile status icons are already complete.

Purpose: Merchants need to see email performance trends over time for each automation flow (PERF-03). PERF-04 (customer profile status icons) was already built in Phase 12-02 and just needs verification.

Output: New time-series query function, new Recharts chart component, updated automation detail page with chart section.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-email-performance-dashboard/15-01-SUMMARY.md
@src/lib/db/queries.ts
@src/components/revenue-chart.tsx
@src/app/(dashboard)/automations/[id]/page.tsx
@src/app/(dashboard)/customers/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add time-series query and EmailPerformanceChart component</name>
  <files>src/lib/db/queries.ts, src/components/email-performance-chart.tsx</files>
  <action>
**Query function (queries.ts):**

Add `getAutomationEmailTimeSeries(shopId, automationId, days = 30)` returning `EmailTimeSeriesItem[]`:

```typescript
export interface EmailTimeSeriesItem {
  date: string          // YYYY-MM-DD
  sent: number
  opened: number
  clicked: number
}
```

SQL query:
```sql
SELECT
  DATE(sent_at) AS date,
  COUNT(*) FILTER (WHERE status IN ('sent','opened','clicked','converted')) AS sent,
  COUNT(*) FILTER (WHERE opened_at IS NOT NULL) AS opened,
  COUNT(*) FILTER (WHERE clicked_at IS NOT NULL) AS clicked
FROM message_logs
WHERE shop_id = $shopId
  AND automation_id = $automationId::uuid
  AND sent_at >= NOW() - ($days || ' days')::interval
  AND status IN ('sent', 'opened', 'clicked', 'converted')
GROUP BY DATE(sent_at)
ORDER BY date ASC
```

Use `db.execute<Row>(sql\`...\`)` pattern. Map rows with `Number()` coercion. Date formatting: `r.date instanceof Date ? r.date.toISOString().slice(0, 10) : String(r.date)`.

**Chart component (email-performance-chart.tsx):**

Create a new `'use client'` component following the pattern of `src/components/revenue-chart.tsx`:

```typescript
interface EmailPerformanceChartProps {
  data: Array<{ date: string; sent: number; opened: number; clicked: number }>
}
```

- Use `ResponsiveContainer` with `height={300}` wrapping a `LineChart`
- Three `Line` elements:
  - `sent`: stroke `#3b82f6` (blue-500), `strokeWidth={2}`, dot={false}
  - `opened`: stroke `#22c55e` (green-500), `strokeWidth={2}`, dot={false}
  - `clicked`: stroke `#f59e0b` (amber-500), `strokeWidth={2}`, dot={false}
- `CartesianGrid` with `strokeDasharray="3 3"` and `className="opacity-30"`
- `XAxis` with `dataKey="date"` and `tickFormatter` that converts YYYY-MM-DD to MM/DD format
- `YAxis` with `tick={{ fontSize: 12 }}` and `width={40}`
- `Tooltip` with a custom tooltip component showing all three values
- `Legend` at the bottom showing Sent/Opened/Clicked labels
- Empty state: if `data.length === 0`, render a centered "No email data yet" message in a 300px container

Import from recharts: `LineChart, Line, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer, CartesianGrid`
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Confirm `email-performance-chart.tsx` exists and exports `EmailPerformanceChart`. Confirm `getAutomationEmailTimeSeries` is exported from queries.ts.</verify>
  <done>Time-series query function and Recharts chart component both exist and type-check cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire chart into automation detail and verify PERF-04</name>
  <files>src/app/(dashboard)/automations/[id]/page.tsx</files>
  <action>
**Automation detail page (automations/[id]/page.tsx):**

1. Import `getAutomationEmailTimeSeries` from `@/lib/db/queries`
2. Import `EmailPerformanceChart` from `@/components/email-performance-chart`
3. Add `getAutomationEmailTimeSeries(shopId, id, 30)` to the existing `Promise.all` call (alongside automationRows, stats, templateOptions)
4. After the existing "Email Performance" stat cards section, add a new chart section:
   - A `div.rounded-lg.border.bg-card.p-6` container
   - `h2.text-lg.font-medium.mb-4` with text "Performance Over Time"
   - `p.text-xs.text-muted-foreground.mb-4` with text "Sends, opens, and clicks per day (last 30 days)"
   - `<EmailPerformanceChart data={timeSeries} />`
   - Place this BETWEEN the Email Performance stat cards and the Configuration section

**PERF-04 Verification (no code changes needed):**

The customer profile at `src/app/(dashboard)/customers/[id]/page.tsx` already has the required status icons from Phase 12-02:
- Check icon (muted) + "Sent" for sent-only messages
- Eye icon (green) + "Opened" + timestamp for opened messages
- Link2 icon (blue) + "Clicked" + timestamp for clicked messages

Verify this by reading the file and confirming the Engagement column exists with CheckIcon, EyeIcon, and Link2Icon from lucide-react. No modification needed.
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Confirm automation detail page imports EmailPerformanceChart and renders it. Confirm customers/[id]/page.tsx has CheckIcon, EyeIcon, Link2Icon engagement column (PERF-04 already complete).</verify>
  <done>Automation detail shows time-series chart with sends/opens/clicks. Customer profile engagement icons verified as already complete from Phase 12.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Automation detail page at `/automations/[id]` shows "Performance Over Time" line chart with 3 lines (sent=blue, opened=green, clicked=amber)
3. Chart shows data for last 30 days with proper date axis
4. Chart handles empty state gracefully (no sends = "No email data yet")
5. Customer profile at `/customers/[id]` has Engagement column with status icons and timestamps (unchanged from Phase 12)
</verification>

<success_criteria>
- PERF-03: Automation detail shows sends/opens/clicks over time line chart (last 30 days)
- PERF-04: Customer profile Message History shows status icons with timestamps (verified as already complete)
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-email-performance-dashboard/15-02-SUMMARY.md`
</output>
