---
phase: 15-email-performance-dashboard
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/queries.ts
  - src/app/(dashboard)/page.tsx
  - src/app/(dashboard)/automations/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows Email Performance section with total sent, open rate, and click rate for last 30 days"
    - "Automation list shows Open Rate and Click Rate columns per flow"
  artifacts:
    - path: "src/lib/db/queries.ts"
      provides: "getEmailPerformanceKpis and getAutomationListWithRates query functions"
      exports: ["getEmailPerformanceKpis", "getAutomationListWithRates"]
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Email Performance card section on main dashboard"
      contains: "Email Performance"
    - path: "src/app/(dashboard)/automations/page.tsx"
      provides: "Open Rate and Click Rate columns in automation list table"
      contains: "Open Rate"
  key_links:
    - from: "src/app/(dashboard)/page.tsx"
      to: "src/lib/db/queries.ts"
      via: "getEmailPerformanceKpis import"
      pattern: "getEmailPerformanceKpis"
    - from: "src/app/(dashboard)/automations/page.tsx"
      to: "src/lib/db/queries.ts"
      via: "getAutomationListWithRates import"
      pattern: "getAutomationListWithRates"
---

<objective>
Add aggregate email performance metrics to the main dashboard and per-flow open/click rate columns to the automation list page.

Purpose: Merchants need to see how their email marketing is performing at both the aggregate level (dashboard) and per-flow level (automation list), satisfying PERF-01 and PERF-02.

Output: Two new query functions in queries.ts, updated dashboard page with Email Performance section, updated automation list with rate columns.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/db/queries.ts
@src/lib/db/schema.ts
@src/app/(dashboard)/page.tsx
@src/app/(dashboard)/automations/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email performance query functions to queries.ts</name>
  <files>src/lib/db/queries.ts</files>
  <action>
Add two new exported query functions to queries.ts:

1. `getEmailPerformanceKpis(shopId: string, days: number = 30)` returning `EmailPerformanceKpis`:
   ```typescript
   export interface EmailPerformanceKpis {
     totalSent: number
     totalOpened: number
     totalClicked: number
     openRate: number   // 0-100 percentage
     clickRate: number  // 0-100 percentage
   }
   ```
   Use a single SQL query against `messageLogs` table:
   - `COUNT(*) FILTER (WHERE status IN ('sent','opened','clicked','converted'))` as total_sent
   - `COUNT(*) FILTER (WHERE opened_at IS NOT NULL)` as total_opened
   - `COUNT(*) FILTER (WHERE clicked_at IS NOT NULL)` as total_clicked
   - WHERE `shop_id = shopId AND sent_at >= NOW() - INTERVAL '{days} days'`
   - Compute openRate/clickRate as `Math.round((n / totalSent) * 100)` with zero-guard

2. `getAutomationListWithRates(shopId: string)` returning `AutomationWithRates[]`:
   ```typescript
   export interface AutomationWithRates {
     id: string
     name: string
     triggerType: string
     triggerConfig: unknown
     delayValue: number | null
     delayUnit: string | null
     actionType: string
     enabled: boolean
     lastRunAt: Date | null
     openRate: number   // 0-100 percentage
     clickRate: number  // 0-100 percentage
   }
   ```
   Use a SQL query joining `automations` LEFT JOIN with a subquery on `messageLogs` that computes per-automation open/click rates:
   ```sql
   SELECT a.*,
     COALESCE(s.open_rate, 0) AS open_rate,
     COALESCE(s.click_rate, 0) AS click_rate
   FROM automations a
   LEFT JOIN (
     SELECT automation_id,
       CASE WHEN COUNT(*) FILTER (WHERE status IN ('sent','opened','clicked','converted')) > 0
         THEN ROUND(COUNT(*) FILTER (WHERE opened_at IS NOT NULL)::numeric /
              COUNT(*) FILTER (WHERE status IN ('sent','opened','clicked','converted')) * 100)
         ELSE 0 END AS open_rate,
       CASE WHEN COUNT(*) FILTER (WHERE status IN ('sent','opened','clicked','converted')) > 0
         THEN ROUND(COUNT(*) FILTER (WHERE clicked_at IS NOT NULL)::numeric /
              COUNT(*) FILTER (WHERE status IN ('sent','opened','clicked','converted')) * 100)
         ELSE 0 END AS click_rate
     FROM message_logs
     WHERE shop_id = $shopId
     GROUP BY automation_id
   ) s ON a.id = s.automation_id
   WHERE a.shop_id = $shopId
   ORDER BY a.created_at ASC
   ```
   Use `db.execute<Row>(sql\`...\`)` pattern consistent with existing queries.
   Map result rows to the `AutomationWithRates` interface with proper type coercion (Number() for rates, Date for lastRunAt).

Both functions should follow established patterns: `extends Record<string, unknown>` for SQL row types, proper null handling, Decimal for money if needed.
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Grep for `getEmailPerformanceKpis` and `getAutomationListWithRates` in queries.ts confirming exports exist.</verify>
  <done>Both query functions exported from queries.ts and type-check cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add Email Performance section to dashboard and rate columns to automation list</name>
  <files>src/app/(dashboard)/page.tsx, src/app/(dashboard)/automations/page.tsx</files>
  <action>
**Dashboard (page.tsx):**

1. Import `getEmailPerformanceKpis` from `@/lib/db/queries`
2. Add it to the existing `Promise.all` call in DashboardPage
3. After the existing KPI cards grid and before the Charts grid, add a new "Email Performance" section:
   - A `div.rounded-lg.border.bg-card.p-6` container
   - `h2.text-sm.font-semibold.mb-4` with text "Email Performance"
   - A `p.text-xs.text-muted-foreground.mb-4` with text "Last 30 days. Open rates may be inflated by Apple Mail Privacy Protection."
   - A 3-column grid (`grid grid-cols-1 sm:grid-cols-3 gap-4`) with:
     - **Total Sent**: `p.text-xs.text-muted-foreground.mb-1` label + `p.text-2xl.font-semibold.tabular-nums` value
     - **Open Rate**: same pattern, display as `{openRate}%`
     - **Click Rate**: same pattern, display as `{clickRate}%`
   - This section should be inside the `kpis.totalCustomers > 0` branch (not in empty state)
   - Place it after the KPI Cards grid and before the Charts grid

**Automation list (automations/page.tsx):**

1. Replace the `listAutomations` import with `getAutomationListWithRates` from `@/lib/db/queries`
2. Update the variable from `automationList` to use `getAutomationListWithRates(shopId)`
3. Add two new `<th>` columns in the table header after "Action" and before "Status":
   - "Open Rate" (text-right alignment)
   - "Click Rate" (text-right alignment)
4. Add corresponding `<td>` cells in each table row:
   - Open Rate: `{automation.openRate}%` with `text-right tabular-nums text-muted-foreground` classes
   - Click Rate: `{automation.clickRate}%` with `text-right tabular-nums text-muted-foreground` classes
5. Display "—" when rate is 0 (no sends) for cleaner UX: `automation.openRate > 0 ? \`${automation.openRate}%\` : '—'`

Both pages are Server Components — no "use client" needed.
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Run `npm run build` or check dev server loads `/` and `/automations` without errors.</verify>
  <done>Dashboard shows Email Performance section with sent/open rate/click rate. Automation list table has Open Rate and Click Rate columns per flow.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Dashboard page at `/` shows "Email Performance" section with Total Sent, Open Rate %, Click Rate % (last 30 days)
3. Automations page at `/automations` shows Open Rate and Click Rate columns in the table
4. Empty states handled: 0% rates show "—" in automation list, Email Performance section only appears when customers exist
</verification>

<success_criteria>
- PERF-01: Dashboard shows "Email Performance" section with total sent, open rate, click rate (last 30 days)
- PERF-02: Automation list shows open rate and click rate columns per flow
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-email-performance-dashboard/15-01-SUMMARY.md`
</output>
