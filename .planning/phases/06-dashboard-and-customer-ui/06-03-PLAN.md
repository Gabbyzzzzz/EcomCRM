---
phase: 06-dashboard-and-customer-ui
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/db/queries.ts
  - src/app/(dashboard)/customers/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Customer 360 profile shows the customer's name, email, phone, segment label, lifecycle stage, and Shopify tags"
    - "RFM scores (R, F, M values and computed segment) are displayed with visual indicators"
    - "Order timeline shows all orders for the customer in reverse chronological order with total price and financial status"
    - "Message history shows all sent emails for the customer with subject, sent date, and open/click status"
    - "Total spent and average order value are displayed as formatted currency"
  artifacts:
    - path: "src/lib/db/queries.ts"
      provides: "Customer profile query functions"
      contains: "getCustomerProfile"
    - path: "src/app/(dashboard)/customers/[id]/page.tsx"
      provides: "Customer 360 profile page"
      contains: "CustomerProfilePage"
  key_links:
    - from: "src/app/(dashboard)/customers/[id]/page.tsx"
      to: "src/lib/db/queries.ts"
      via: "server-side query calls"
      pattern: "getCustomerProfile|getCustomerOrders|getCustomerMessages"
---

<objective>
Build the customer 360 profile page showing a complete view of a single customer: personal info, RFM scores with segment label, order timeline, Shopify tags, lifecycle stage, and full message history with open/click status.

Purpose: The 360 profile is the deep-dive view — users need to see everything about a customer in one place to make decisions and understand behavior.
Output: A fully data-driven customer profile page at `/customers/[id]`.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/db/schema.ts
@src/lib/db/queries.ts
@src/lib/env.ts
@src/app/(dashboard)/layout.tsx
@.planning/phases/06-dashboard-and-customer-ui/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add customer profile query functions and build the 360 profile page</name>
  <files>src/lib/db/queries.ts, src/app/(dashboard)/customers/[id]/page.tsx</files>
  <action>
**Part A: Add queries to src/lib/db/queries.ts**

Add three new query functions to the bottom of queries.ts:

1. **getCustomerProfile(shopId: string, customerId: string)** — Fetches a single customer by internal UUID (id column, not shopifyId). Returns the full customer row or null. Use `db.select().from(customers).where(and(eq(customers.id, customerId), eq(customers.shopId, shopId))).limit(1)`. Return `row ?? null`.

2. **getCustomerOrders(shopId: string, customerId: string)** — Fetches all orders for a customer. Returns array of order rows. Query: `db.select().from(orders).where(and(eq(orders.customerId, customerId), eq(orders.shopId, shopId))).orderBy(desc(orders.shopifyCreatedAt))`. No limit — show all orders for the customer.

3. **getCustomerMessages(shopId: string, customerId: string)** — Fetches all message_logs for a customer, joined with automations to get the automation name. Use Drizzle leftJoin:
   ```typescript
   db.select({
     id: messageLogs.id,
     automationName: automations.name,
     channel: messageLogs.channel,
     subject: messageLogs.subject,
     status: messageLogs.status,
     sentAt: messageLogs.sentAt,
     openedAt: messageLogs.openedAt,
     clickedAt: messageLogs.clickedAt,
   })
   .from(messageLogs)
   .leftJoin(automations, eq(messageLogs.automationId, automations.id))
   .where(and(eq(messageLogs.customerId, customerId), eq(messageLogs.shopId, shopId)))
   .orderBy(desc(messageLogs.sentAt))
   ```

**Part B: Build the customer 360 profile page**

Create `src/app/(dashboard)/customers/[id]/page.tsx` as a Server Component.

**Metadata:**
```typescript
export async function generateMetadata({ params }: { params: Promise<{ id: string }> }) {
  // Return a simple title — no DB call needed for metadata
  return { title: 'Customer Profile | EcomCRM' }
}
```

**Data fetching:**
- Extract `id` from `params` (Next.js 14 App Router dynamic route: `{ params }: { params: Promise<{ id: string }> }`). Await params: `const { id } = await params`.
- Derive `shopId` from env.
- Call all three queries in parallel with `Promise.all`.
- If `customer` is null, import `notFound` from `next/navigation` and call it.

**Layout — Tailwind grid, all within `<div className="flex flex-col gap-6">`:**

1. **Header** — flex row with back link and customer name:
   - `<Link href="/customers">` with left arrow text "Back to Customers"
   - `<h1>` with customer name (or "Unknown Customer" if null)
   - Segment badge (colored, same palette as customer list)

2. **Info Cards Row** — `grid grid-cols-1 md:grid-cols-3 gap-4`:

   **Card 1: Customer Info**
   - `rounded-lg border bg-card p-6`
   - Heading: "Customer Info"
   - Fields: Email, Phone (or "—" if null), Lifecycle Stage (or "—"), Created date
   - Each field: label (text-sm text-muted-foreground) + value

   **Card 2: RFM Scores**
   - Heading: "RFM Scores"
   - Three score displays:
     - Recency (R): value 1-5 with a visual bar (e.g., colored div with width proportional to score/5). Display as "R: 4/5".
     - Frequency (F): same pattern
     - Monetary (M): same pattern
   - Below: Segment label in bold with the colored badge
   - If any score is null, show "Not scored yet"

   **Card 3: Financials**
   - Heading: "Financials"
   - Total Spent: formatted as $X,XXX.XX
   - Order Count: number
   - Avg Order Value: formatted as $X,XXX.XX
   - First Order: date or "—"
   - Last Order: date or "—"

3. **Tags Section** — full width card:
   - Heading: "Shopify Tags"
   - If tags array exists and non-empty: render each tag as a `<span>` badge (rounded-full bg-muted px-3 py-1 text-xs)
   - If empty or null: "No tags"

4. **Order Timeline** — full width card:
   - Heading: "Order History" with count badge (e.g., "12 orders")
   - HTML table: Date (formatted as "Jan 15, 2026"), Order ID (truncated shopifyId), Total Price (formatted currency), Financial Status (colored badge: paid=green, pending=yellow, refunded=red, etc.)
   - If no orders: "No orders yet"
   - Show all orders (no pagination needed for per-customer view — typically <100 orders per customer)

5. **Message History** — full width card:
   - Heading: "Message History" with count badge
   - HTML table: Date (sentAt formatted), Subject, Automation Name, Status, Opened, Clicked
   - Status column: colored badge (sent=blue, opened=green, clicked=green, suppressed=gray, failed=red)
   - Opened column: "Yes" with openedAt date, or "—"
   - Clicked column: "Yes" with clickedAt date, or "—"
   - If no messages: "No messages sent yet"

**Formatting helpers** (define in the file or import):
- `formatCurrency(value: string | null)`: returns "$0.00" if null, otherwise `Number(value).toLocaleString('en-US', { style: 'currency', currency: 'USD' })`
- `formatDate(date: Date | null)`: returns "—" if null, otherwise `date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })`

**Important:** This is entirely a Server Component — no `'use client'` needed. All data is fetched server-side. Use `params.id` as the customer's internal UUID.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Visit `/customers/{some-uuid}` — the page shows customer info, RFM scores, order timeline, tags, and message history. If customer not found, returns 404.</verify>
  <done>Customer 360 profile page shows complete customer data: info, RFM scores with segment, financials, tags, order timeline, and message history with open/click status</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 6 dashboard and customer UI</name>
  <action>
Human verification step. All automated tasks across plans 06-01, 06-02, and 06-03 are complete. Verify the full Phase 6 dashboard and customer UI works end-to-end:
1. Dashboard page with 4 KPI cards, segment distribution chart, revenue over time chart, churn alerts, and activity feed
2. Customer list page with pagination, search by name/email, and segment filter
3. Customer 360 profile page with RFM scores, order timeline, tags, and message history
  </action>
  <verify>
1. Start the dev server: `npm run dev`
2. Visit http://localhost:3000/ — verify dashboard shows:
   - 4 KPI cards with numbers (may be 0 if no data)
   - Segment distribution bar chart (bars colored by segment)
   - Revenue over time line chart (blue line)
   - Churn alerts section (customers in at_risk/hibernating/lost)
   - Recent activity feed (merged email sends + orders)

3. Visit http://localhost:3000/customers — verify:
   - Customer table with name, email, segment badge, total spent columns
   - Type in search box — results filter after ~300ms debounce
   - Select a segment from dropdown — results filter immediately
   - Click Next/Previous pagination buttons — rows change
   - Click a customer name — navigates to /customers/[id]

4. On customer profile page, verify:
   - Customer name, email, phone displayed
   - RFM scores (R/F/M values 1-5) with visual bars and segment badge
   - Total spent and order count shown as formatted currency
   - Shopify tags displayed as pill badges
   - Order history table with dates, amounts, and financial status
   - Message history table with subject, sent date, opened/clicked status
   - "Back to Customers" link returns to /customers

5. Check TypeScript: `npx tsc --noEmit` — zero errors
  </verify>
  <done>All three pages (dashboard, customer list, customer profile) render correctly with live database data. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Customer profile page loads at `/customers/[uuid]` with full data
3. Non-existent customer UUID returns 404 page
4. Order timeline shows orders in reverse chronological order
5. Message history shows sent emails with open/click timestamps
6. RFM scores render with visual indicators (1-5 scale)
7. Tags render as badge elements
8. All currency values formatted correctly
</verification>

<success_criteria>
- Customer 360 profile page loads at /customers/[id] with all 5 sections (info, RFM, financials, tags, orders, messages)
- Order timeline shows all orders for the customer
- Message history shows all emails with open/click status
- RFM scores displayed with visual bars and segment label
- Profile returns 404 for non-existent customer IDs
- TypeScript strict — no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard-and-customer-ui/06-03-SUMMARY.md`
</output>
