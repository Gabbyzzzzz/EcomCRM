---
phase: 08-pipeline-verification-and-toggle-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/automations/page.tsx
  - src/app/(dashboard)/automations/[id]/page.tsx
  - src/app/api/automations/[id]/route.ts
  - src/components/automation-toggle.tsx
autonomous: false

must_haves:
  truths:
    - "Toggling an automation off via the UI switch and reloading the page shows it still off"
    - "Toggling an automation on via the UI switch and reloading the page shows it still on"
    - "The automation badge shows 'Active' when enabled=true and 'Inactive' when enabled=false on both the list page and the detail page"
    - "The PATCH /api/automations/[id] endpoint writes the enabled field to the database and returns the updated automation row"
  artifacts:
    - path: "src/app/(dashboard)/automations/page.tsx"
      provides: "Automation list page with correct 'Active'/'Inactive' badge text"
      contains: "'Inactive'"
    - path: "src/app/(dashboard)/automations/[id]/page.tsx"
      provides: "Automation detail page with correct 'Active'/'Inactive' badge text"
      contains: "'Inactive'"
    - path: "src/app/api/automations/[id]/route.ts"
      provides: "PATCH endpoint that persists enabled field and returns updated row"
      exports: ["PATCH"]
    - path: "src/components/automation-toggle.tsx"
      provides: "Toggle component with optimistic update and server refresh"
  key_links:
    - from: "src/components/automation-toggle.tsx"
      to: "/api/automations/[id]"
      via: "fetch PATCH request with { enabled: boolean }"
      pattern: "fetch.*api/automations.*PATCH"
    - from: "src/app/api/automations/[id]/route.ts"
      to: "src/lib/db/queries.ts (setAutomationEnabled)"
      via: "function call"
      pattern: "setAutomationEnabled"
    - from: "src/app/(dashboard)/automations/page.tsx"
      to: "src/lib/db/queries.ts (listAutomations)"
      via: "server component data fetch"
      pattern: "listAutomations"
---

<objective>
Fix the automation toggle persistence and update badge text to show "Active"/"Inactive" (not "Disabled") per PIPE-03 and PIPE-04.

Purpose: The automation toggle must persist to the database (not just local state), and the badge text must read "Active" when ON and "Inactive" when OFF on both the list and detail pages. Currently the badge says "Disabled" instead of "Inactive".

Output: Verified toggle persistence with correct badge labels on both pages.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/(dashboard)/automations/page.tsx
@src/app/(dashboard)/automations/[id]/page.tsx
@src/app/api/automations/[id]/route.ts
@src/components/automation-toggle.tsx
@src/lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix badge text and verify toggle persistence</name>
  <files>src/app/(dashboard)/automations/page.tsx, src/app/(dashboard)/automations/[id]/page.tsx, src/app/api/automations/[id]/route.ts</files>
  <action>
Three changes are needed:

1. **Fix badge text on list page** (`src/app/(dashboard)/automations/page.tsx`):
   - Line ~129: Change `{automation.enabled ? 'Active' : 'Disabled'}` to `{automation.enabled ? 'Active' : 'Inactive'}`
   - This is the only change needed on this file.

2. **Fix badge text on detail page** (`src/app/(dashboard)/automations/[id]/page.tsx`):
   - Line ~85: Change `{automation.enabled ? 'Active' : 'Disabled'}` to `{automation.enabled ? 'Active' : 'Inactive'}`
   - This is the only change needed on this file.

3. **Enhance PATCH endpoint to return the updated row** (`src/app/api/automations/[id]/route.ts`):
   - Currently returns `{ ok: true }` which gives no confirmation of the actual DB state.
   - After calling `setAutomationEnabled(id, parsed.data.enabled)`, query the automation row back from the DB and return it in the response: `return NextResponse.json({ ok: true, automation: { id, enabled: updatedRow.enabled } })`.
   - This allows the client to verify the server state matches expectations.
   - Add a GET handler to this route that returns the full automation row (for use by other components that need to fetch fresh server state). Use the same pattern: derive shopId from env, query by id + shopId, return 404 if not found.

Do NOT change the toggle component (`src/components/automation-toggle.tsx`) — it already correctly does optimistic update + router.refresh() which re-renders the server component with fresh DB data.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Then:
1. Start the dev server
2. Visit /automations — verify all badges say "Active" or "Inactive" (not "Disabled")
3. Toggle one automation off — verify the badge changes to "Inactive"
4. Reload the page — verify the automation is still showing "Inactive"
5. Toggle it back on — verify "Active" appears
6. Reload again — verify "Active" persists
7. Visit the detail page for that automation — verify the badge matches
  </verify>
  <done>Badge text shows "Active"/"Inactive" on both pages. Toggle state persists across page reloads. PATCH endpoint returns the updated automation state.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify toggle persistence and badge display</name>
  <files>src/app/(dashboard)/automations/page.tsx, src/app/(dashboard)/automations/[id]/page.tsx</files>
  <action>
Human verification checkpoint. Present the following verification steps to the user:

1. Start the dev server: `npm run dev`
2. Visit http://localhost:3000/automations
3. Verify all automation badges show either "Active" or "Inactive" (NOT "Disabled")
4. Click the toggle switch on one automation to turn it OFF
5. Wait for the page to update — badge should show "Inactive"
6. Hard refresh the page (Cmd+Shift+R) — the automation should STILL show "Inactive"
7. Toggle it back ON — badge should show "Active"
8. Hard refresh again — should still show "Active"
9. Click the automation name to go to its detail page — verify the badge there also shows "Active"/"Inactive" correctly matching the toggle state
  </action>
  <verify>User confirms toggle persistence works and badges display "Active"/"Inactive" correctly.</verify>
  <done>User has verified that PIPE-03 (toggle persistence) and PIPE-04 (badge text) are working correctly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Badge text is "Active"/"Inactive" on both /automations and /automations/[id] pages
3. Toggle state persists across hard page reloads
4. PATCH /api/automations/[id] returns the updated automation state
5. GET /api/automations/[id] returns the full automation row
</verification>

<success_criteria>
- All automation badges display "Active" when enabled and "Inactive" when disabled (PIPE-04)
- Toggle state persists to the database across page reloads (PIPE-03)
- Both list and detail pages reflect the correct persisted state
</success_criteria>

<output>
After completion, create `.planning/phases/08-pipeline-verification-and-toggle-fix/08-02-SUMMARY.md`
</output>
