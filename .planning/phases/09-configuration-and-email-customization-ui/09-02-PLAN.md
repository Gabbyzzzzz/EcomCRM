---
phase: 09-configuration-and-email-customization-ui
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/emails/welcome.tsx
  - src/emails/winback.tsx
  - src/emails/repurchase.tsx
  - src/emails/abandoned-cart.tsx
  - src/emails/vip.tsx
  - src/app/api/automations/[id]/preview/route.ts
  - src/components/email-preview-panel.tsx
  - src/components/automation-detail-client.tsx
  - src/app/(dashboard)/automations/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Live email preview panel on automation detail page re-renders in real time as user edits subject, body, or discount fields — no save required"
    - "All 5 email templates accept customBody, customHeadline, and customCtaText optional props and render them when provided"
  artifacts:
    - path: "src/app/api/automations/[id]/preview/route.ts"
      provides: "POST endpoint returning rendered HTML for email preview"
      exports: ["POST"]
    - path: "src/components/email-preview-panel.tsx"
      provides: "Client component showing live email preview iframe"
      min_lines: 50
    - path: "src/components/automation-detail-client.tsx"
      provides: "Client wrapper owning form state shared between AutomationConfigForm and EmailPreviewPanel"
      min_lines: 40
    - path: "src/emails/welcome.tsx"
      provides: "Welcome template with customBody/customHeadline/customCtaText props"
    - path: "src/emails/winback.tsx"
      provides: "Winback template with customBody/customHeadline/customCtaText props"
    - path: "src/emails/repurchase.tsx"
      provides: "Repurchase template with customBody/customHeadline/customCtaText props"
    - path: "src/emails/abandoned-cart.tsx"
      provides: "Abandoned cart template with customBody/customHeadline/customCtaText props"
    - path: "src/emails/vip.tsx"
      provides: "VIP template with customBody/customHeadline/customCtaText props"
  key_links:
    - from: "src/components/email-preview-panel.tsx"
      to: "/api/automations/[id]/preview"
      via: "fetch POST with current form values"
      pattern: "fetch.*api/automations.*preview"
    - from: "src/components/automation-detail-client.tsx"
      to: "src/components/automation-config-form.tsx"
      via: "passes values + onFieldChange as props to controlled form"
      pattern: "AutomationConfigForm.*values.*onFieldChange"
    - from: "src/components/automation-detail-client.tsx"
      to: "src/components/email-preview-panel.tsx"
      via: "passes current actionConfig fields as preview props"
      pattern: "EmailPreviewPanel.*subject.*body"
---

<objective>
Add custom content props to all 5 email templates, build the live email preview panel, and create the AutomationDetailClient wrapper that shares form state between the config form and preview panel.

Purpose: Satisfies ECUST-01 (live preview updates in real-time as user edits fields, no save required). Also adds the template-level prop support (customBody/customHeadline/customCtaText) needed by both the preview and the send path (Plan 09-03).
Output: Updated email templates, preview API, EmailPreviewPanel component, AutomationDetailClient wrapper, updated detail page.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-configuration-and-email-customization-ui/09-01-SUMMARY.md

@src/emails/welcome.tsx
@src/emails/winback.tsx
@src/emails/repurchase.tsx
@src/emails/abandoned-cart.tsx
@src/emails/vip.tsx
@src/components/automation-config-form.tsx
@src/app/(dashboard)/automations/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add custom content props to all 5 email templates</name>
  <files>src/emails/welcome.tsx, src/emails/winback.tsx, src/emails/repurchase.tsx, src/emails/abandoned-cart.tsx, src/emails/vip.tsx</files>
  <action>
Add three optional props to each email template's props interface: `customBody?: string`, `customHeadline?: string`, `customCtaText?: string`. When present, these override the default hardcoded text.

For each template:
1. Add the three optional props to the existing props interface (e.g. `WelcomeEmailProps`)
2. In the JSX, use `customHeadline ?? defaultHeadline` for the heading text
3. Use `customBody ?? defaultBodyParagraph` for the main body paragraph
4. Use `customCtaText ?? defaultButtonText` for the CTA button text
5. Keep all other template structure, styling, and props unchanged

**Specific per-template notes:**
- `welcome.tsx`: heading is the welcome line, body is the paragraph below, CTA is likely a "Shop Now" or "Get Started" button
- `winback.tsx`: also has `incentive` prop — `customBody` overrides the main paragraph, NOT the incentive text. If `customBody` is provided AND discountCode should appear, the caller handles that.
- `repurchase.tsx`: body overrides the main paragraph about reordering
- `abandoned-cart.tsx`: body overrides the paragraph about the abandoned items
- `vip.tsx`: body overrides the VIP welcome paragraph

These are small, surgical edits — 3-5 lines changed per file. Do NOT restructure the template layout.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors across all 5 template files. Verify each template's props interface includes the three optional fields and the JSX uses conditional rendering.
  </verify>
  <done>All 5 email templates accept customBody, customHeadline, and customCtaText as optional props and render them when provided, falling back to defaults when not.</done>
</task>

<task type="auto">
  <name>Task 2: Create preview API, EmailPreviewPanel, and AutomationDetailClient wrapper</name>
  <files>src/app/api/automations/[id]/preview/route.ts, src/components/email-preview-panel.tsx, src/components/automation-detail-client.tsx, src/app/(dashboard)/automations/[id]/page.tsx</files>
  <action>
**Create `src/app/api/automations/[id]/preview/route.ts`** — POST endpoint that renders a React Email template with custom overrides and returns HTML.

Zod body schema:
```typescript
const previewSchema = z.object({
  emailTemplateId: z.string(),
  subject: z.string().optional(),
  headline: z.string().optional(),
  body: z.string().optional(),
  ctaText: z.string().optional(),
  discountCode: z.string().optional(),
})
```

Implementation:
- Parse body with previewSchema
- Build the appropriate React Email element by template ID, passing `customBody`, `customHeadline`, `customCtaText` overrides as props (from Task 1)
- For ALL templates: storeName defaults to env.RESEND_FROM_NAME, customerName = "Preview Customer", unsubscribeUrl = "#"
- For winback: if discountCode is present, pass it as `incentive: \`Use code ${discountCode}\``
- Render the element with `render()` from @react-email/render
- Return `Response.json({ html, subject: overrides.subject ?? SUBJECT_MAP[templateId] })`

**Create `src/components/email-preview-panel.tsx`** — `'use client'` component.

Props:
```typescript
interface EmailPreviewPanelProps {
  automationId: string
  emailTemplateId: string | null
  subject?: string
  headline?: string
  body?: string
  ctaText?: string
  discountCode?: string
}
```

Behavior:
- Uses `useEffect` with a debounce (500ms via setTimeout) to fetch preview HTML whenever subject/headline/body/ctaText/discountCode props change
- POSTs to `/api/automations/${automationId}/preview` with current values
- Stores returned HTML in state
- Renders an iframe (via `srcDoc={html}`) inside a bordered panel, styled to look like an email client preview (max-width 600px, centered, with a subtle border and "Email Preview" header label)
- Shows a loading skeleton while fetching
- If emailTemplateId is null, show "No email template configured" placeholder

**Create `src/components/automation-detail-client.tsx`** — `'use client'` wrapper.

This component OWNS the form state and coordinates between AutomationConfigForm (controlled component from 09-01) and EmailPreviewPanel.

Props:
```typescript
interface AutomationDetailClientProps {
  automationId: string
  triggerType: string
  emailTemplateId: string | null
  initialDelayValue: number | null
  initialDelayUnit: string | null
  initialTriggerConfig: Record<string, unknown> | null
  initialActionConfig: Record<string, unknown> | null
}
```

Implementation:
- Uses `useState` for `AutomationFormValues` (delayValue, delayUnit, triggerConfig, actionConfig) initialized from `initial*` props
- Uses `useRef` for "last saved" snapshot — updated after successful Save
- Derives `isDirty` by deep-comparing current values to the ref
- `onFieldChange` callback updates the appropriate field in state
- `onSave` calls PATCH `/api/automations/${automationId}` with all current values, shows `toast.success('Automation saved')` or `toast.error(message)`, calls `router.refresh()` on success, and updates the "last saved" ref
- `onCancel` resets state to "last saved" ref values
- Renders AutomationConfigForm with `values`, `onFieldChange`, `onSave`, `onCancel`, `isDirty`, `isSaving` props
- Renders EmailPreviewPanel with `automationId`, `emailTemplateId`, and current actionConfig fields (subject, headline, body, ctaText, discountCode) extracted from state
- Layout: Configuration form on top/left, email preview panel on bottom/right (2-column on lg, stacked on mobile)

**IMPORTANT REFACTOR:** Plan 09-01 Task 2 creates a minimal local client wrapper inside the detail page. This task EXTRACTS that wrapper into `automation-detail-client.tsx`, adds EmailPreviewPanel rendering, and updates the detail page to import `AutomationDetailClient` instead.

**Update `src/app/(dashboard)/automations/[id]/page.tsx`:**
- Remove the local client wrapper created in 09-01 (move logic to AutomationDetailClient)
- Import and render `AutomationDetailClient`, passing initial values from the server query
- Keep static read-only items (trigger type label, action type, template ID, last run) in the server component above the client wrapper
- Keep Send Test Email and AI Copy Generator sections below
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Visit an automation detail page — email preview renders with default template content. Edit the body text field — preview updates within ~500ms without clicking Save.
  </verify>
  <done>Live email preview panel shows rendered email that updates in real-time as user edits subject, body, headline, CTA, or discount fields. AutomationDetailClient wrapper owns form state shared between the controlled config form and preview panel. No save required to see preview changes.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Visit automation detail page — live email preview renders below the config form
3. Edit subject or body text — preview re-renders within 500ms showing updated content
4. All 5 templates render correctly with custom overrides via the preview API
5. Form Save/Cancel still works correctly after the wrapper extraction
</verification>

<success_criteria>
- All 5 email templates accept customBody/customHeadline/customCtaText optional props
- Live email preview panel renders on automation detail page and updates in real-time on field changes
- AutomationDetailClient owns form state and passes it to both AutomationConfigForm and EmailPreviewPanel
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-configuration-and-email-customization-ui/09-02-SUMMARY.md`
</output>
