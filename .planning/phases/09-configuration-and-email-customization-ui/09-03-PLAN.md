---
phase: 09-configuration-and-email-customization-ui
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/lib/automation/actions.ts
  - src/inngest/functions.ts
  - src/app/api/automations/[id]/send-test/route.ts
autonomous: true

must_haves:
  truths:
    - "When an automation fires after configuration changes, the sent email uses the customized subject, headline, body text, CTA, and discount code — not template defaults"
    - "Test-send endpoint uses customized content from actionConfig when sending test emails"
  artifacts:
    - path: "src/lib/automation/actions.ts"
      provides: "executeEmailAction reads actionConfig overrides from automation row"
      exports: ["executeEmailAction"]
    - path: "src/inngest/functions.ts"
      provides: "All Inngest automation functions pass actionConfig to executeEmailAction"
    - path: "src/app/api/automations/[id]/send-test/route.ts"
      provides: "Test-send route uses actionConfig overrides for customized test emails"
      exports: ["POST"]
  key_links:
    - from: "src/inngest/functions.ts"
      to: "src/lib/automation/actions.ts"
      via: "passes actionConfig from automation row to executeEmailAction"
      pattern: "executeEmailAction.*actionConfig"
    - from: "src/lib/automation/actions.ts"
      to: "email templates"
      via: "passes customBody/customHeadline/customCtaText props to React Email elements"
      pattern: "customBody.*customHeadline.*customCtaText"
    - from: "src/app/api/automations/[id]/send-test/route.ts"
      to: "actionConfig overrides"
      via: "reads actionConfig from body or DB for customized test send"
      pattern: "actionConfig|customBody|customHeadline"
---

<objective>
Wire customized action_config from the database into the automation send path (executeEmailAction) and test-send endpoint, so saved configuration overrides are used when automations fire.

Purpose: Satisfies ECUST-02 — when an automation fires after configuration changes, the sent email uses the customized subject, headline, body text, CTA, and discount code instead of template defaults.
Output: Updated executeEmailAction with actionConfig support, updated Inngest function callers, updated test-send route.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-configuration-and-email-customization-ui/09-01-SUMMARY.md

@src/lib/automation/actions.ts
@src/inngest/functions.ts
@src/app/api/automations/[id]/send-test/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add actionConfig support to executeEmailAction</name>
  <files>src/lib/automation/actions.ts</files>
  <action>
**Update `src/lib/automation/actions.ts` — executeEmailAction:**

Currently `executeEmailAction` uses hardcoded `SUBJECT_MAP` for subjects and passes no custom content to templates. After 09-01, automations can have `actionConfig` with custom overrides stored in the DB. After 09-02, templates accept `customBody`/`customHeadline`/`customCtaText` props.

Changes:
1. Add an optional `actionConfig` parameter to `EmailActionParams`:
   ```typescript
   actionConfig?: Record<string, unknown> | null
   ```
2. At the top of executeEmailAction, extract overrides:
   ```typescript
   const config = actionConfig as {
     subject?: string
     headline?: string
     body?: string
     ctaText?: string
     discountCode?: string
     alsoAddTag?: string
   } | null
   ```
3. For subject: use `config?.subject || SUBJECT_MAP[emailTemplateId]` (custom subject takes priority)
4. In each template switch case, pass custom overrides when constructing the React element:
   - Add `customBody: config?.body`, `customHeadline: config?.headline`, `customCtaText: config?.ctaText` to the props object in each `React.createElement()` call
   - For winback: if `config?.discountCode` is present, pass it as `incentive: \`Use code ${config.discountCode}\``
   - For other templates that have discount-like props, thread the discountCode similarly
5. Keep backward compatibility: when `actionConfig` is undefined/null, all behavior is identical to current code (SUBJECT_MAP used, no custom props passed)
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Read the updated code to verify executeEmailAction reads actionConfig for subject/body/headline overrides and passes customBody/customHeadline/customCtaText to each template.
  </verify>
  <done>executeEmailAction accepts an optional actionConfig parameter, uses custom subject when present, and passes customBody/customHeadline/customCtaText overrides to all 5 email template constructors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire actionConfig through Inngest callers and update test-send route</name>
  <files>src/inngest/functions.ts, src/app/api/automations/[id]/send-test/route.ts</files>
  <action>
**Update `src/inngest/functions.ts`** — find every call to `executeEmailAction` and add `actionConfig: automation.actionConfig ?? null` (or the equivalent field from the fetched automation row). There are 4 callers:

1. `processFirstOrder` (line ~625): `executeEmailAction({ ..., actionConfig: automation.actionConfig ?? null })`
2. `processSegmentChange` (line ~685): `executeEmailAction({ ..., actionConfig: automation.actionConfig ?? null })`
3. `processCartAbandoned` (line ~770): `executeEmailAction({ ..., actionConfig: automation.actionConfig ?? null })`
4. `checkDaysSinceOrder` (line ~875): `executeEmailAction({ ..., actionConfig: automation.actionConfig ?? null })`

The automation row's `actionConfig` is already available since each function fetches the full automation row via `fetchEnabledAutomationsByTrigger`. Verify the return type includes `actionConfig` — it should since it selects the full row. If the type doesn't include it, check the query in `engine.ts`.

**Update `src/app/api/automations/[id]/send-test/route.ts`:**

Currently `buildTestTemplate` uses hardcoded test values. Update it to:
1. Extend bodySchema to include optional `subject`, `headline`, `body`, `ctaText`, `discountCode` fields
2. Read the automation's `actionConfig` from the DB row (already fetched)
3. Merge with three-layer priority: body params override > DB actionConfig > hardcoded defaults
4. Pass `customBody`/`customHeadline`/`customCtaText` props to the template construction in `buildTestTemplate`
5. For the subject line: use `[TEST] ${overrides.subject || (automation.actionConfig as any)?.subject || automation.name}`

This ensures test-send uses the customized content from either:
- The currently edited (unsaved) form values passed in the request body, OR
- The saved DB values in actionConfig (if no overrides in body)
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Check all 4 Inngest function calls pass actionConfig. Verify test-send route accepts and uses override fields.
  </verify>
  <done>All 4 Inngest automation functions pass actionConfig to executeEmailAction. Test-send route accepts custom content overrides in request body and uses three-layer priority (body > DB actionConfig > defaults). The full send path respects user configuration.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Save custom subject "Hello World" for welcome flow, then trigger it via test-trigger API — the sent email has subject "Hello World" not "Welcome to our store!"
3. Test-send with custom body text — received email shows the custom body
4. All 4 Inngest functions pass actionConfig to executeEmailAction
</verification>

<success_criteria>
- executeEmailAction reads actionConfig overrides from its params
- All 4 Inngest automation functions pass actionConfig from the automation row
- Test-send endpoint uses customized content with three-layer priority
- Saved configuration overrides are used when automations fire
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-configuration-and-email-customization-ui/09-03-SUMMARY.md`
</output>
