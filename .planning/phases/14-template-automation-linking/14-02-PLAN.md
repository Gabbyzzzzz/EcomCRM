---
phase: 14-template-automation-linking
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/automation-detail-client.tsx
  - src/components/automation-inline-editor.tsx
  - src/app/api/automations/[id]/route.ts
  - src/app/api/automations/[id]/preview/route.ts
autonomous: true

must_haves:
  truths:
    - "'Customize for this Flow' button copies linked template into custom_template_html/json and opens inline Unlayer editor"
    - "Inline Unlayer editor saves flow-specific edits back to custom_template_html/json on the automation row"
    - "Dynamic variables (customer_name, store_name, discount_code, unsubscribe_url, shop_url) inject correctly in Unlayer templates via merge tags"
    - "Clearing customization reverts to linked template (sets custom_template_html/json to null)"
  artifacts:
    - path: "src/components/automation-inline-editor.tsx"
      provides: "Inline Unlayer editor for flow-specific template customization"
      contains: "UnlayerInlineEditor"
    - path: "src/components/automation-detail-client.tsx"
      provides: "Customize for this Flow button and Clear Customization button"
      contains: "Customize for this Flow"
  key_links:
    - from: "src/components/automation-inline-editor.tsx"
      to: "/api/automations/[id]"
      via: "PATCH with customTemplateHtml and customTemplateJson"
      pattern: "customTemplateHtml"
    - from: "src/components/automation-detail-client.tsx"
      to: "src/components/automation-inline-editor.tsx"
      via: "renders inline editor when customizing"
      pattern: "AutomationInlineEditor"
---

<objective>
Add "Customize for this Flow" functionality that copies the linked template into the automation's custom columns, opens an inline Unlayer editor for flow-specific edits, and configures Unlayer merge tags for dynamic variable injection (customer_name, store_name, discount_code, unsubscribe_url, shop_url).

Purpose: Merchants need to tweak templates per-flow (e.g., different welcome copy for first_order vs. segment_change) without modifying the shared library template. Merge tags make templates dynamic so customer-specific data injects at send time.

Output: Inline Unlayer editor on automation detail page with merge tag support. Custom edits saved to automation row. Clear button reverts to linked template.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-template-automation-linking/14-01-SUMMARY.md
@.planning/phases/13-email-template-editor/13-02-SUMMARY.md

Key source files (post Plan 14-01):
@src/components/automation-detail-client.tsx
@src/components/email-editor/UnlayerEditor.tsx (reference for Unlayer patterns)
@src/app/api/automations/[id]/route.ts
@src/lib/automation/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inline Unlayer editor component with merge tags and "Customize for this Flow" integration</name>
  <files>
    src/components/automation-inline-editor.tsx
    src/components/automation-detail-client.tsx
  </files>
  <action>
1. **Create `src/components/automation-inline-editor.tsx`** — a 'use client' component that renders an inline Unlayer editor for flow-specific template customization. Reference the existing `UnlayerEditor.tsx` patterns but adapt for inline use (not full-screen).

   Props:
   - `automationId: string`
   - `initialDesign: object | null` — the design JSON to load (copied from linked template or existing custom design)
   - `onSave: (html: string, designJson: object) => Promise<void>` — callback when user saves
   - `onClose: () => void` — callback to close the editor

   Implementation:
   - Use `dynamic(() => import('react-email-editor'), { ssr: false })` same as UnlayerEditor.tsx
   - Pin Unlayer to version 1.157.0 (same as existing editor — locked decision from Phase 13)
   - Register merge tags in the `onReady` callback using `unlayer.setMergeTags()`:
     ```typescript
     unlayer.setMergeTags({
       customer_name: { name: 'Customer Name', value: '{{customer_name}}' },
       store_name: { name: 'Store Name', value: '{{store_name}}' },
       discount_code: { name: 'Discount Code', value: '{{discount_code}}' },
       unsubscribe_url: { name: 'Unsubscribe URL', value: '{{unsubscribe_url}}' },
       shop_url: { name: 'Shop URL', value: '{{shop_url}}' },
     })
     ```
   - Register image upload callback same as UnlayerEditor.tsx (POST to /api/uploads/image)
   - Load initialDesign on ready (with designLoadedRef guard for StrictMode)
   - Render with a header bar containing "Editing for this flow" label, Save button, and Cancel/Close button
   - Save button calls `unlayer.exportHtml((data) => ...)` then passes html + design to onSave callback
   - Editor height: 500px (inline, not full-screen)
   - Wrap in a bordered container with rounded corners to visually distinguish from the rest of the page

2. **Update `src/components/automation-detail-client.tsx`**:
   - Add state: `isCustomizing: boolean` (controls whether inline editor is visible)
   - Add state: `customDesignJson: object | null` (the design JSON for the inline editor)
   - Add a "Customize for this Flow" button that:
     a) If `customTemplateJson` already exists (from props), opens the inline editor with that JSON
     b) If no custom JSON but `linkedEmailTemplateId` exists, fetches the linked template's designJson via GET `/api/email-templates/${linkedEmailTemplateId}` and opens the inline editor with that JSON
     c) If neither exists, shows a toast "Select a template first"
   - Add a "Clear Customization" button (only visible when customTemplateHtml is not null):
     a) Confirms with the user ("Remove flow-specific edits? This will revert to the linked template.")
     b) PATCHes the automation with `customTemplateHtml: null, customTemplateJson: null`
     c) Updates local state and refreshes
   - Render `AutomationInlineEditor` when `isCustomizing` is true, below the template selector
   - The onSave callback should:
     a) PATCH `/api/automations/${automationId}` with `{ customTemplateHtml: html, customTemplateJson: designJson }`
     b) Show toast "Custom template saved"
     c) Set `isCustomizing: false`
     d) Refresh the page to update preview
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify that:
    1. AutomationInlineEditor component renders Unlayer with merge tags
    2. "Customize for this Flow" button copies linked template design into editor
    3. Save persists to custom_template_html/json via PATCH
    4. "Clear Customization" nulls both custom columns
  </verify>
  <done>
    "Customize for this Flow" button appears on automation detail when a template is linked. Clicking it opens an inline Unlayer editor loaded with the linked template's design (or existing customization). Merge tags (customer_name, store_name, discount_code, unsubscribe_url, shop_url) appear in the Unlayer merge tag menu. Saving persists to custom_template_html/json. "Clear Customization" reverts to the linked template.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure variable substitution in send pipeline and preview handles all merge tags</name>
  <files>
    src/lib/automation/actions.ts
    src/app/api/automations/[id]/preview/route.ts
  </files>
  <action>
1. **Verify and enhance `substituteVariables` in `src/lib/automation/actions.ts`** (created in Plan 14-01):
   - Ensure the function handles all 5 merge tags: `{{customer_name}}`, `{{store_name}}`, `{{discount_code}}`, `{{unsubscribe_url}}`, `{{shop_url}}`
   - For `{{customer_name}}`: use the customer's name from the DB lookup (already fetched in executeEmailAction)
   - For `{{store_name}}`: use `env.RESEND_FROM_NAME ?? 'EcomCRM'` (same as existing storeName)
   - For `{{discount_code}}`: use `actionConfig.discountCode ?? ''` (from the automation's action config)
   - For `{{unsubscribe_url}}`: this is the URL generated by `buildUnsubscribeUrl`. The substituteVariables call MUST happen AFTER the unsubscribe URL is built, passing it in the variables map
   - For `{{shop_url}}`: use `env.SHOPIFY_STORE_URL`
   - If a variable value is empty/undefined, replace the tag with empty string (don't leave `{{discount_code}}` in the output)
   - Use a global regex: `html.replace(/\{\{(\w+)\}\}/g, (match, key) => vars[key] ?? '')` — this handles any merge tag pattern

2. **Verify the preview endpoint** (`src/app/api/automations/[id]/preview/route.ts`) applies substituteVariables for tiers 1 and 2:
   - For preview, use dummy values: `customer_name = "Preview Customer"`, `store_name = env.RESEND_FROM_NAME`, `discount_code = "PREVIEW10"`, `unsubscribe_url = "#"`, `shop_url = "#"`
   - Import and call substituteVariables on the HTML before returning it
   - Ensure the preview endpoint imports the same substituteVariables helper used by the send pipeline (avoid duplication)

3. **Export substituteVariables** from actions.ts so the preview endpoint can import it. Alternatively, move it to a shared utility like `src/lib/email/variables.ts` if it makes the import cleaner. Either way, both the send pipeline and preview endpoint must use the same function.

4. **Edge case handling**:
   - If a linked template has no HTML (designJson only, no HTML yet), the fallback should skip to tier 3 (React Email). Add a check: `if (linkedTemplate && linkedTemplate.html)` before using tier 2.
   - If customTemplateHtml exists but is an empty string, treat it as null (skip to tier 2).
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors. Trace through the send pipeline manually:
    1. Automation has customTemplateHtml with `{{customer_name}}` tag -> substituted with real customer name at send time
    2. Automation has linkedEmailTemplateId pointing to template with `{{store_name}}` -> fetched and substituted
    3. Automation has neither -> falls through to React Email (existing behavior, unchanged)
    4. Preview endpoint returns HTML with dummy values substituted for all merge tags
  </verify>
  <done>
    substituteVariables replaces all 5 merge tags (customer_name, store_name, discount_code, unsubscribe_url, shop_url) in any HTML template. The same function is used by both the send pipeline (with real values) and the preview endpoint (with dummy values). Edge cases handled: empty HTML skips to next tier, missing variables replaced with empty string.
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes with zero errors
2. UI: "Customize for this Flow" button visible when a template is linked
3. Editor: Inline Unlayer editor opens with linked template's design, merge tags visible in toolbar
4. Save: Custom edits persist to custom_template_html/json on the automation row
5. Clear: "Clear Customization" nulls custom columns, preview reverts to linked template
6. Variables: `{{customer_name}}` etc. replaced at send time with real values and at preview time with dummy values
7. Fallback: All 3 tiers work correctly — custom > linked > React Email (tier 3 never fails)
</verification>

<success_criteria>
- "Customize for this Flow" copies linked template design into inline Unlayer editor
- Inline editor shows merge tags in the UI for easy insertion
- Saving custom edits persists HTML + JSON to automation row
- "Clear Customization" reverts to linked template
- Dynamic variables inject correctly at send time (real values) and preview time (dummy values)
- 3-tier fallback end-to-end: custom HTML with variables -> linked template HTML with variables -> React Email template
</success_criteria>

<output>
After completion, create `.planning/phases/14-template-automation-linking/14-02-SUMMARY.md`
</output>
