---
phase: 02-shopify-integration
plan: "03"
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/sync-indicator.tsx
  - src/components/sync-status-detail.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/settings/sync/page.tsx
  - src/app/api/sync/status/route.ts
autonomous: false

must_haves:
  truths:
    - "Nav shows a compact sync indicator with three visual states: idle, in-progress spinner, and stale/error badge"
    - "User can trigger 'Sync Now' from the nav indicator"
    - "Auto-sync triggers automatically on first run when no data exists (lastSyncAt is null)"
    - "Stale sync (>24h without completion) shows a red dot on the nav indicator"
    - "Settings/sync page shows full sync details: last sync time, record counts, dead letter count"
    - "Force full sync is available behind an Advanced toggle on the settings page"
    - "Live progress counter updates during sync ('Synced 1,234 / 5,000 customers')"
    - "Success toast shows 'Sync complete: X customers, Y orders imported' with actual counts when sync finishes"
  artifacts:
    - path: "src/components/sync-indicator.tsx"
      provides: "Nav sync indicator with idle/spinning/stale states, Sync Now button, and auto-trigger on first run"
      min_lines: 50
    - path: "src/components/sync-status-detail.tsx"
      provides: "Detailed sync status for settings page"
      min_lines: 40
    - path: "src/app/settings/sync/page.tsx"
      provides: "Settings sync page with full details and force sync option"
    - path: "src/app/api/sync/status/route.ts"
      provides: "SSE or polling endpoint for live sync progress"
      exports: ["GET"]
  key_links:
    - from: "src/components/sync-indicator.tsx"
      to: "/api/sync/status"
      via: "polling or SSE for live progress updates"
      pattern: "fetch.*api/sync"
    - from: "src/components/sync-indicator.tsx"
      to: "/api/sync"
      via: "POST to trigger sync (manual Sync Now or auto first-run)"
      pattern: "fetch.*api/sync.*POST"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/components/sync-indicator.tsx"
      via: "SyncIndicator rendered in nav"
      pattern: "SyncIndicator"
---

<objective>
Build the sync status UI: nav indicator with three visual states (idle/spinning/stale), Sync Now button, auto-trigger on first run, live progress counter, completion toast, and settings/sync page with full details and force sync option.

Purpose: SHOP-09 requires sync status visibility. User decisions mandate the nav indicator serves triple duty (idle, spinner, stale badge), auto-sync on first run, and live progress feedback during sync operations.

Output: Sync indicator component, settings sync page, live progress API endpoint.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-shopify-integration/02-01-SUMMARY.md
@.planning/phases/02-shopify-integration/02-02-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/db/queries.ts
@src/app/api/sync/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync status API endpoint and nav indicator component</name>
  <files>src/app/api/sync/status/route.ts, src/components/sync-indicator.tsx, src/app/(dashboard)/layout.tsx</files>
  <action>
**Create `src/app/api/sync/status/route.ts`:**

GET handler that returns current sync status:
- Query getLatestSyncLog from db/queries
- Query count of webhook_deliveries with status='dead_letter' for the dead letter count
- If a sync is currently 'running', also query the syncLog's customersCount and ordersCount (updated periodically during sync processing)
- Return JSON: `{ status: 'idle' | 'running' | 'completed' | 'failed', lastSyncAt: string | null, isStale: boolean, customersCount: number, ordersCount: number, deadLetterCount: number, progress?: { current: number, total: number } }`
- `isStale`: true if no sync completed in the past 24 hours (or no sync has ever run)
- Support `?history=true` query param to also return recent sync_logs (last 10) for the settings page

This endpoint will be polled by the client (every 10 seconds when idle, every 2 seconds when sync is running).

**Create `src/components/sync-indicator.tsx`:**

This is a Client Component ("use client").

Use shadcn/ui components: Button, Popover (or DropdownMenu), Badge. Use lucide-react icons: RefreshCw (spinning when syncing), CheckCircle2 (idle/success), AlertCircle (stale/error).

**Three visual states per user decision:**
1. **Idle (healthy)**: Small green dot or CheckCircle2 icon + "Last synced X ago" text. If sync completed <24h ago.
2. **Running (in-progress)**: RefreshCw icon with CSS animation `animate-spin`. Shows live counter: "Syncing... 1,234 customers, 567 orders". Counter updates via polling /api/sync/status every 2 seconds.
3. **Stale/Error**: Red dot badge (per user decision — red dot, no banner, no modal) + AlertCircle icon. Shown when isStale=true or last sync failed.

**Sync Now button:** Always visible in the indicator. Clicking sends POST to /api/sync. While running, button is disabled and shows spinner.

**Auto-sync on first run (LOCKED DECISION):** When the component mounts and the first /api/sync/status response returns `lastSyncAt === null` (no data exists yet), automatically trigger a POST to /api/sync to start the initial full sync. This must happen without user interaction — the app self-syncs on first ever load. Add a `hasAutoTriggered` ref to prevent duplicate auto-triggers. Only auto-trigger once per mount; after that, user must click "Sync Now" manually.

**Completion toast (LOCKED DECISION):** When polling detects the sync status transitions from 'running' to 'completed', display a success toast with the format: "Sync complete: X customers, Y orders imported" using the actual customersCount and ordersCount from the status response. Use sonner (if available) or react-hot-toast (if available) or implement a simple toast component. The toast must show actual counts, not placeholder text.

**Implementation details:**
- Use `useState` + `useEffect` with `setInterval` for polling
- Poll /api/sync/status every 10s normally, every 2s when status='running'
- Format timestamps with relative time ("5 minutes ago", "2 hours ago") — implement a simple `formatRelativeTime` helper, no external lib needed
- On clicking Sync Now: POST /api/sync, then immediately start polling at 2s interval
- Track previous status in a ref to detect transitions (e.g., 'running' -> 'completed') for the completion toast

**Layout:** Compact — fits in a nav bar. Use a Popover that expands on click to show more details (last sync time, counts, "View full sync details" link to /settings/sync).

**Create or update `src/app/(dashboard)/layout.tsx`:**

If this file exists, add the SyncIndicator component to the nav/header area.
If it does not exist, create a minimal dashboard layout:
- A sidebar or top nav with the app name "EcomCRM"
- SyncIndicator in the nav bar (top-right area or near the logo)
- `{children}` for page content
- Server Component wrapper with the client SyncIndicator imported

Use Tailwind CSS for all styling. Use shadcn/ui primitives where available (check components.json for configured components — install any needed ones with `npx shadcn@latest add [component]` before using).
  </action>
  <verify>Run `npm run build` (or at minimum TypeScript compilation) to verify no type errors. Verify SyncIndicator is imported and rendered in the dashboard layout. Verify: (1) auto-sync logic exists — check for `lastSyncAt === null` condition triggering POST /api/sync, (2) completion toast exists — check for status transition detection and toast call with customer/order counts.</verify>
  <done>Nav shows sync indicator with three states. Sync Now triggers POST /api/sync. Auto-sync fires on first run when lastSyncAt is null. Polling updates progress in real-time. Stale sync shows red dot badge. Success toast shows "Sync complete: X customers, Y orders imported" with actual counts when sync finishes.</done>
</task>

<task type="auto">
  <name>Task 2: Settings/sync page with full details and force sync</name>
  <files>src/app/settings/sync/page.tsx, src/components/sync-status-detail.tsx</files>
  <action>
**Create `src/components/sync-status-detail.tsx`:**

Client Component showing detailed sync information:
- Last successful sync: timestamp + relative time
- Records synced: X customers, Y orders (from latest completed sync)
- Current sync status: idle / running with progress / failed with error message
- Dead letter count: number of webhook deliveries with status='dead_letter' — per user decision, shown as a separate count
- Sync history: list of recent sync_logs (last 10) showing type, status, started_at, completed_at, counts

Uses the same /api/sync/status endpoint with `?history=true` query param that also returns recent sync_logs.

**Create `src/app/settings/sync/page.tsx`:**

Server Component page at /settings/sync.

Sections:
1. **Sync Status** — renders SyncStatusDetail component with current state
2. **Sync Actions:**
   - "Sync Now" button (incremental — same as nav, calls POST /api/sync)
   - "Force Full Sync" button — behind an "Advanced" toggle/disclosure per user's specific idea. Calls POST /api/sync with `{ force: true }`. Add a confirmation dialog: "This will re-import all data from Shopify. Only use this if incremental sync is not working correctly. Continue?"
3. **Sync History** — table of recent sync_logs
4. **Dead Letters** — count and link to view details (just the count for now, detailed view can be added later)

Use Tailwind CSS + shadcn/ui components (Card, Button, Table, AlertDialog for force sync confirmation, Collapsible or Accordion for the Advanced toggle).

Install any needed shadcn components: `npx shadcn@latest add card table alert-dialog collapsible` (check which are already available first).
  </action>
  <verify>TypeScript compilation passes. Page renders at /settings/sync route. Force sync is behind Advanced toggle. Dead letter count displayed.</verify>
  <done>Settings/sync page shows full sync details, sync history, dead letter count. Force full sync available behind Advanced toggle with confirmation dialog. SHOP-09 fully satisfied.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Shopify integration UI and endpoints</name>
  <files>n/a</files>
  <action>
Human verifies the complete Phase 2 Shopify integration — sync indicator in nav, settings/sync page, webhook endpoint, and bulk sync pipeline.
  </action>
  <verify>
1. Start the app: `npm run dev`
2. Check the nav bar — sync indicator should show (likely stale/error state since no sync has run)
3. If this is the FIRST run ever (no sync_logs), verify the auto-sync triggers automatically (a POST to /api/sync fires without clicking anything)
4. Visit /settings/sync — should show sync details page with empty state
5. Click "Sync Now" in nav or settings page — should trigger sync (will fail without real Shopify credentials, but the request should reach the API)
6. Visit /api/sync/status — should return JSON with current status
7. Send a POST to /api/webhooks/shopify without HMAC — should return 401
8. Check the Advanced toggle hides the Force Full Sync button
9. Verify the completion toast format shows actual counts (test with mock data if needed)
  </verify>
  <done>All Phase 2 UI and endpoints verified: nav indicator shows correct states, auto-sync triggers on first run, completion toast shows counts, settings page renders, webhook rejects unauthorized requests, sync triggers correctly.</done>
</task>

</tasks>

<verification>
- Sync indicator shows in nav with three visual states
- Auto-sync triggers on first run when no data exists (lastSyncAt === null)
- Completion toast shows "Sync complete: X customers, Y orders imported" with actual counts
- Polling updates sync status in real-time
- Settings/sync page displays full details
- Force full sync is behind Advanced toggle with confirmation
- Dead letter count is visible on settings page
- SHOP-09 satisfied: "Last synced X ago" + stale alert
</verification>

<success_criteria>
- SHOP-09: Sync status visible in UI, alert on stale (>24h), working Sync Now button
- User decision honored: Nav indicator with triple duty (idle/spinner/stale badge)
- User decision honored: Auto-sync on first run when no data exists
- User decision honored: Completion toast with "Sync complete: X customers, Y orders imported" format
- User decision honored: Live progress counter during sync
- User decision honored: Force full sync behind Advanced toggle
- User decision honored: Dead letter count on settings page
</success_criteria>

<output>
After completion, create `.planning/phases/02-shopify-integration/02-03-SUMMARY.md`
</output>
