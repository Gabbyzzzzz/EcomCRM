---
phase: 02-shopify-integration
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - CLAUDE.md
  - .planning/REQUIREMENTS.md
  - .planning/codebase/STACK.md
  - .planning/codebase/INTEGRATIONS.md
  - .planning/codebase/STRUCTURE.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "CLAUDE.md env vars section lists SHOPIFY_CLIENT_ID and SHOPIFY_CLIENT_SECRET, not SHOPIFY_ACCESS_TOKEN"
    - "REQUIREMENTS.md FOUND-05 references SHOPIFY_CLIENT_ID and SHOPIFY_CLIENT_SECRET, not SHOPIFY_ACCESS_TOKEN"
    - "All .planning/codebase/ docs that listed SHOPIFY_ACCESS_TOKEN now list SHOPIFY_CLIENT_ID + SHOPIFY_CLIENT_SECRET"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Accurate env var documentation matching env.ts"
      contains: "SHOPIFY_CLIENT_ID"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Accurate FOUND-05 requirement"
      contains: "SHOPIFY_CLIENT_ID"
    - path: ".planning/codebase/STACK.md"
      provides: "Accurate env var list in codebase map"
      contains: "SHOPIFY_CLIENT_ID"
  key_links:
    - from: "CLAUDE.md (Env Vars section)"
      to: "src/lib/env.ts (envSchema)"
      via: "documentation mirror"
      pattern: "SHOPIFY_CLIENT_ID"
---

<objective>
Close Gap 3: documentation-only env var mismatch from Phase 2 verification.

A post-plan refactor (commit ea8b9bb) replaced `SHOPIFY_ACCESS_TOKEN` with `SHOPIFY_CLIENT_ID` + `SHOPIFY_CLIENT_SECRET` in the runtime code. The actual `src/lib/env.ts` envSchema is correct. However, five documentation files still reference the old `SHOPIFY_ACCESS_TOKEN` variable. This plan updates those five files to match the runtime truth.

Purpose: Future phases, developers, and planning agents reading these docs will get accurate information about which env vars are actually required.
Output: Five updated documentation files. No code changes.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@src/lib/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CLAUDE.md and REQUIREMENTS.md env var references</name>
  <files>CLAUDE.md, .planning/REQUIREMENTS.md</files>
  <action>
**CLAUDE.md — Shopify Integration section and Env Vars section:**

In the "Shopify Integration" section (lines 72-81), the current text reads:
- `SHOPIFY_CLIENT_ID` + `SHOPIFY_CLIENT_SECRET` in env (Partners Dashboard credentials)
- `SHOPIFY_ACCESS_TOKEN` in env for single-store dev convenience; in production tokens are stored per-store in DB

The actual env.ts does NOT include `SHOPIFY_ACCESS_TOKEN` at all — the OAuth client credentials grant (client_id + client_secret) is used directly to obtain short-lived tokens at runtime. Remove the `SHOPIFY_ACCESS_TOKEN` line from the Shopify Integration section. The two lines should become:
- `SHOPIFY_CLIENT_ID` + `SHOPIFY_CLIENT_SECRET` in env (Partners Dashboard credentials — used via OAuth client credentials grant to obtain access tokens at runtime)
- Store URL in env var `SHOPIFY_STORE_URL`

In the "Env Vars Needed" code block (lines 107-120), remove the `SHOPIFY_ACCESS_TOKEN=` line entirely. The block currently shows:
```
SHOPIFY_STORE_URL=
SHOPIFY_CLIENT_ID=           # Partners Dashboard client ID
SHOPIFY_CLIENT_SECRET=       # Partners Dashboard client secret
SHOPIFY_ACCESS_TOKEN=        # OAuth access token (dev convenience; prod stores in DB)
SHOPIFY_WEBHOOK_SECRET=      # Same value as SHOPIFY_CLIENT_SECRET
```

It should become:
```
SHOPIFY_STORE_URL=
SHOPIFY_CLIENT_ID=           # Partners Dashboard client ID
SHOPIFY_CLIENT_SECRET=       # Partners Dashboard client secret
SHOPIFY_WEBHOOK_SECRET=      # Same value as SHOPIFY_CLIENT_SECRET
```

This matches exactly what src/lib/env.ts validates.

**REQUIREMENTS.md — FOUND-05:**

Line 16 currently reads:
```
- [ ] **FOUND-05**: All env vars documented and loaded (SHOPIFY_STORE_URL, SHOPIFY_ACCESS_TOKEN, SHOPIFY_WEBHOOK_SECRET, DATABASE_URL, RESEND_API_KEY, ANTHROPIC_API_KEY, INNGEST_EVENT_KEY, INNGEST_SIGNING_KEY)
```

Replace with:
```
- [ ] **FOUND-05**: All env vars documented and loaded (SHOPIFY_STORE_URL, SHOPIFY_CLIENT_ID, SHOPIFY_CLIENT_SECRET, SHOPIFY_WEBHOOK_SECRET, DATABASE_URL, NEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, RESEND_API_KEY, ANTHROPIC_API_KEY, INNGEST_EVENT_KEY, INNGEST_SIGNING_KEY)
```

This matches the 11 vars in env.ts exactly (DATABASE_URL, NEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, SHOPIFY_STORE_URL, SHOPIFY_CLIENT_ID, SHOPIFY_CLIENT_SECRET, SHOPIFY_WEBHOOK_SECRET, RESEND_API_KEY, ANTHROPIC_API_KEY, INNGEST_EVENT_KEY, INNGEST_SIGNING_KEY).

Do NOT change any other requirements, traceability table, or formatting.
  </action>
  <verify>
`grep "SHOPIFY_ACCESS_TOKEN" /Users/zhangjiabei/Desktop/ecomcrm/CLAUDE.md` — must return zero results.
`grep "SHOPIFY_CLIENT_ID" /Users/zhangjiabei/Desktop/ecomcrm/CLAUDE.md` — must return at least 2 results (Shopify Integration section + Env Vars block).
`grep "SHOPIFY_ACCESS_TOKEN" /Users/zhangjiabei/Desktop/ecomcrm/.planning/REQUIREMENTS.md` — must return zero results.
`grep "SHOPIFY_CLIENT_ID" /Users/zhangjiabei/Desktop/ecomcrm/.planning/REQUIREMENTS.md` — must show the updated FOUND-05 line.
  </verify>
  <done>
- CLAUDE.md contains no references to SHOPIFY_ACCESS_TOKEN.
- CLAUDE.md Env Vars block matches src/lib/env.ts exactly (11 vars, no SHOPIFY_ACCESS_TOKEN).
- REQUIREMENTS.md FOUND-05 lists SHOPIFY_CLIENT_ID and SHOPIFY_CLIENT_SECRET instead of SHOPIFY_ACCESS_TOKEN.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update codebase map docs (STACK.md, INTEGRATIONS.md, STRUCTURE.md)</name>
  <files>.planning/codebase/STACK.md, .planning/codebase/INTEGRATIONS.md, .planning/codebase/STRUCTURE.md</files>
  <action>
**STACK.md — Verified env vars list:**

The Configuration section lists required env vars. Currently contains:
```
- `SHOPIFY_ACCESS_TOKEN` - Custom App API token
```

Remove that line. Add in its place:
```
- `SHOPIFY_CLIENT_ID` - Partners Dashboard OAuth client ID
- `SHOPIFY_CLIENT_SECRET` - Partners Dashboard OAuth client secret (also used as webhook secret)
```

Also update the comment at the bottom of the Shopify Runtime Constraints section if it references Custom App:
- "Shopify Custom App (not Public App) requires explicit access token" → update to: "Shopify OAuth app (Partners Dashboard) uses SHOPIFY_CLIENT_ID + SHOPIFY_CLIENT_SECRET via client credentials grant — no static access token"

**INTEGRATIONS.md — Shopify section:**

In the Shopify Admin API block, currently:
- Auth: Custom App access token
- Auth Env Var: `SHOPIFY_ACCESS_TOKEN`

Replace with:
- Auth: OAuth client credentials grant (Partners Dashboard app)
- Auth Env Vars: `SHOPIFY_CLIENT_ID` + `SHOPIFY_CLIENT_SECRET`

In the Environment Configuration section, replace:
```
- `SHOPIFY_ACCESS_TOKEN` - Custom App private API token
```
with:
```
- `SHOPIFY_CLIENT_ID` - Partners Dashboard OAuth client ID
- `SHOPIFY_CLIENT_SECRET` - Partners Dashboard OAuth client secret (doubles as SHOPIFY_WEBHOOK_SECRET value)
```

In the Auth Provider section, update:
- "Custom App access token from Shopify (not OAuth)" → "OAuth client credentials grant using Partners Dashboard app (SHOPIFY_CLIENT_ID + SHOPIFY_CLIENT_SECRET)"

**STRUCTURE.md — Special Directories / .env.local section:**

Line 286 currently reads:
```
- Required vars: SHOPIFY_STORE_URL, SHOPIFY_ACCESS_TOKEN, SHOPIFY_WEBHOOK_SECRET, DATABASE_URL, SUPABASE_SERVICE_ROLE_KEY, RESEND_API_KEY, ANTHROPIC_API_KEY, INNGEST_EVENT_KEY, INNGEST_SIGNING_KEY
```

Replace with:
```
- Required vars: SHOPIFY_STORE_URL, SHOPIFY_CLIENT_ID, SHOPIFY_CLIENT_SECRET, SHOPIFY_WEBHOOK_SECRET, DATABASE_URL, NEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, RESEND_API_KEY, ANTHROPIC_API_KEY, INNGEST_EVENT_KEY, INNGEST_SIGNING_KEY
```

Do NOT change file structure descriptions, directory purposes, naming conventions, or any non-env-var content in these files.
  </action>
  <verify>
`grep "SHOPIFY_ACCESS_TOKEN" /Users/zhangjiabei/Desktop/ecomcrm/.planning/codebase/STACK.md` — must return zero results.
`grep "SHOPIFY_ACCESS_TOKEN" /Users/zhangjiabei/Desktop/ecomcrm/.planning/codebase/INTEGRATIONS.md` — must return zero results.
`grep "SHOPIFY_ACCESS_TOKEN" /Users/zhangjiabei/Desktop/ecomcrm/.planning/codebase/STRUCTURE.md` — must return zero results.
`grep "SHOPIFY_CLIENT_ID" /Users/zhangjiabei/Desktop/ecomcrm/.planning/codebase/STACK.md` — must return at least 1 result.
`grep "SHOPIFY_CLIENT_ID" /Users/zhangjiabei/Desktop/ecomcrm/.planning/codebase/INTEGRATIONS.md` — must return at least 2 results.
  </verify>
  <done>
- STACK.md, INTEGRATIONS.md, and STRUCTURE.md contain zero references to SHOPIFY_ACCESS_TOKEN.
- All three files reference SHOPIFY_CLIENT_ID and SHOPIFY_CLIENT_SECRET in their env var listings.
- No structural or non-env-var content was changed.
  </done>
</task>

</tasks>

<verification>
After both tasks:

`grep -r "SHOPIFY_ACCESS_TOKEN" /Users/zhangjiabei/Desktop/ecomcrm/CLAUDE.md /Users/zhangjiabei/Desktop/ecomcrm/.planning/REQUIREMENTS.md /Users/zhangjiabei/Desktop/ecomcrm/.planning/codebase/` — must return zero results (the only remaining references should be in VERIFICATION.md, phase SUMMARYs, and research/ which are historical records).

`grep -r "SHOPIFY_CLIENT_ID" /Users/zhangjiabei/Desktop/ecomcrm/CLAUDE.md /Users/zhangjiabei/Desktop/ecomcrm/.planning/REQUIREMENTS.md /Users/zhangjiabei/Desktop/ecomcrm/.planning/codebase/` — must return results in all five updated files.
</verification>

<success_criteria>
- Zero `SHOPIFY_ACCESS_TOKEN` references in CLAUDE.md, REQUIREMENTS.md, STACK.md, INTEGRATIONS.md, STRUCTURE.md.
- All five files reference SHOPIFY_CLIENT_ID and SHOPIFY_CLIENT_SECRET where auth env vars are listed.
- Documentation now matches src/lib/env.ts exactly (Gap 3 resolved).
</success_criteria>

<output>
After completion, create `.planning/phases/02-shopify-integration/02-05-SUMMARY.md`
</output>
