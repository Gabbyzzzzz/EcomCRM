---
phase: 12-open-and-click-tracking
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/lib/email/send.ts
  - src/lib/db/queries.ts
  - src/app/(dashboard)/customers/[id]/page.tsx
  - src/app/(dashboard)/automations/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Every outgoing marketing email HTML contains a 1x1 tracking pixel img tag pointing to /api/track/open?id={messageLogId}"
    - "Every link in outgoing marketing email HTML is rewritten to /api/track/click?id={messageLogId}&url={encodedOriginalUrl}"
    - "Unsubscribe links are NOT rewritten (List-Unsubscribe header URL and in-body unsubscribe link remain direct)"
    - "Customer profile Message History shows status icons (sent checkmark, opened eye, clicked link) with timestamps"
    - "Automation detail page shows per-flow open rate and click rate computed from message_logs + email_clicks"
  artifacts:
    - path: "src/lib/email/send.ts"
      provides: "Tracking pixel injection and link rewriting in sendMarketingEmail"
      contains: "injectTrackingPixel"
    - path: "src/lib/db/queries.ts"
      provides: "getAutomationEmailStats query function"
      contains: "getAutomationEmailStats"
    - path: "src/app/(dashboard)/customers/[id]/page.tsx"
      provides: "Message History with status icons and timestamps"
      contains: "openedAt"
    - path: "src/app/(dashboard)/automations/[id]/page.tsx"
      provides: "Open rate and click rate section on automation detail"
      contains: "openRate"
  key_links:
    - from: "src/lib/email/send.ts"
      to: "/api/track/open"
      via: "tracking pixel img src URL in injected HTML"
      pattern: "api/track/open"
    - from: "src/lib/email/send.ts"
      to: "/api/track/click"
      via: "rewritten href URLs in outgoing HTML"
      pattern: "api/track/click"
    - from: "src/lib/email/send.ts"
      to: "src/lib/db/schema.ts"
      via: "INSERT returning id to get messageLogId for tracking URLs"
      pattern: "returning"
    - from: "src/app/(dashboard)/automations/[id]/page.tsx"
      to: "src/lib/db/queries.ts"
      via: "getAutomationEmailStats call"
      pattern: "getAutomationEmailStats"
---

<objective>
Wire tracking pixel injection and link rewriting into the email send pipeline, then update the customer profile and automation detail UIs to display open/click engagement data.

Purpose: Close the tracking loop — emails sent through sendMarketingEmail become trackable, and the UI surfaces the engagement data.
Output: Modified sendMarketingEmail with pixel + link rewriting, updated customer profile message history with status icons, automation detail page with open/click rates.
</objective>

<execution_context>
@/Users/zhangjiabei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zhangjiabei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-open-and-click-tracking/12-01-SUMMARY.md
@src/lib/email/send.ts
@src/lib/db/schema.ts
@src/lib/db/queries.ts
@src/app/(dashboard)/customers/[id]/page.tsx
@src/app/(dashboard)/automations/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inject tracking pixel and rewrite links in sendMarketingEmail</name>
  <files>src/lib/email/send.ts</files>
  <action>
The key challenge: we need the `messageLogId` (the UUID of the inserted message_logs row) to build tracking URLs, but currently the messageLog INSERT happens AFTER the Resend send call. We must restructure to INSERT the messageLog row first (with status 'sent'), get back its id, then inject tracking into the HTML, then send via Resend.

Modify `sendMarketingEmail` in `src/lib/email/send.ts`:

1. **Restructure the send flow** (Step 7 and Step 8):
   - BEFORE sending via Resend, INSERT the messageLog row with status 'sent' and sentAt = new Date(), using `.returning()` to get the generated `id` back. Store this as `messageLogId`.
   - After inserting, inject tracking into the rendered HTML.
   - Then send via Resend with the modified HTML.
   - If Resend returns an error, UPDATE the messageLog row to status 'failed' (instead of inserting a new row).
   - Remove the old post-send INSERT that was in Step 8.

2. **Add `injectTrackingPixel` helper function** (before the main function):
   ```typescript
   function injectTrackingPixel(html: string, messageLogId: string): string {
     const pixelUrl = `${env.APP_URL}/api/track/open?id=${messageLogId}`
     const pixelTag = `<img src="${pixelUrl}" width="1" height="1" alt="" style="display:block;width:1px;height:1px;border:0;" />`
     // Insert before closing </body> tag if present, otherwise append
     if (html.includes('</body>')) {
       return html.replace('</body>', `${pixelTag}</body>`)
     }
     return html + pixelTag
   }
   ```

3. **Add `rewriteLinks` helper function**:
   ```typescript
   function rewriteLinks(html: string, messageLogId: string): string {
     const baseUrl = env.APP_URL
     // Match href="..." in anchor tags, but skip unsubscribe links and mailto: links
     return html.replace(
       /(<a\s[^>]*href=")([^"]+)(")/gi,
       (match, prefix, url, suffix) => {
         // Skip unsubscribe links — must remain direct for compliance
         if (url.includes('/unsubscribe')) return match
         // Skip mailto: links
         if (url.startsWith('mailto:')) return match
         // Skip anchor links
         if (url.startsWith('#')) return match
         // Skip non-http(s) links
         if (!url.startsWith('http://') && !url.startsWith('https://')) return match
         // Rewrite to click tracking redirect
         const trackUrl = `${baseUrl}/api/track/click?id=${messageLogId}&url=${encodeURIComponent(url)}`
         return `${prefix}${trackUrl}${suffix}`
       }
     )
   }
   ```

4. **Update the main flow** — replace the current Step 7 (send via Resend) and Step 8 (log successful send):

   ```
   // ── Step 7: Pre-insert MessageLog to get messageLogId for tracking URLs ──
   let messageLogId: string
   try {
     const [logRow] = await db.insert(messageLogs).values({
       shopId,
       customerId: customerInternalId,
       automationId: automationId ?? null,
       channel: 'email',
       subject,
       status: 'sent',
       sentAt: new Date(),
     }).returning({ id: messageLogs.id })
     messageLogId = logRow.id
   } catch (err) {
     console.error('[sendMarketingEmail] Failed to pre-insert MessageLog:', err)
     return { sent: false, reason: 'error' }
   }

   // ── Step 8: Inject tracking pixel + rewrite links ──
   const trackedHtml = rewriteLinks(injectTrackingPixel(html, messageLogId), messageLogId)

   // ── Step 9: Send via Resend ──
   try {
     const fromAddress = `${env.RESEND_FROM_NAME} <${env.RESEND_FROM_EMAIL}>`
     const { data, error } = await resend.emails.send(
       {
         from: fromAddress,
         to: email,
         subject,
         html: trackedHtml,  // <-- use trackedHtml instead of html
         replyTo: env.RESEND_REPLY_TO ?? undefined,
         headers: {
           'List-Unsubscribe': `<${unsubscribeUrl}>`,
           'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click',
         },
         tags: [{ name: 'shop_id', value: shopId }],
       },
       { idempotencyKey }
     )

     if (error || !data) {
       console.error('[sendMarketingEmail] Resend returned error:', error)
       // Update pre-inserted log to failed
       try {
         await db.update(messageLogs).set({ status: 'failed' }).where(eq(messageLogs.id, messageLogId))
       } catch { /* ignore secondary failure */ }
       return { sent: false, reason: 'error' }
     }

     return { sent: true, reason: 'sent', resendId: data.id }
   } catch (err) { ... update to failed ... }
   ```

5. **Import `eq` from drizzle-orm** at the top of the file (add to existing imports or create new import). It's needed for the `db.update(...).where(eq(...))` call.

6. **Add a code comment** near the tracking pixel injection documenting Apple MPP as a known limitation:
   ```
   // NOTE: Apple Mail Privacy Protection (MPP) pre-fetches images including tracking
   // pixels, inflating open rates. Click rate is the more reliable engagement metric.
   ```

Important: The `logSuppressed` helper and the error/catch paths that insert failed messageLogs should remain unchanged — they don't need tracking since the email was never sent.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Verify that:
    1. `injectTrackingPixel` adds an img tag before closing body tag with /api/track/open?id=xxx URL.
    2. `rewriteLinks` rewrites http(s) hrefs to /api/track/click?id=xxx&url=encodedUrl.
    3. `rewriteLinks` does NOT rewrite unsubscribe links (contains '/unsubscribe').
    4. MessageLog is pre-inserted with `.returning()` to get the id.
    5. If Resend fails, the pre-inserted row is updated to status 'failed'.
    6. MPP limitation is documented in a code comment.
  </verify>
  <done>
    sendMarketingEmail pre-inserts messageLog to get id, injects tracking pixel before closing body tag, rewrites all links (except unsubscribe/mailto) through /api/track/click, and documents MPP limitation. Failed sends update the pre-inserted row to 'failed' status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update customer profile message history with status icons, and add open/click rates to automation detail</name>
  <files>src/lib/db/queries.ts, src/app/(dashboard)/customers/[id]/page.tsx, src/app/(dashboard)/automations/[id]/page.tsx</files>
  <action>
**Part A: Add getAutomationEmailStats query (src/lib/db/queries.ts)**

Add a new exported async function `getAutomationEmailStats`:

```typescript
export interface AutomationEmailStats {
  totalSent: number
  totalOpened: number
  totalClicked: number
  openRate: number    // 0-100 percentage
  clickRate: number   // 0-100 percentage
}

export async function getAutomationEmailStats(
  shopId: string,
  automationId: string
): Promise<AutomationEmailStats> {
  interface StatsRow extends Record<string, unknown> {
    total_sent: string | number
    total_opened: string | number
    total_clicked: string | number
  }

  const rows = await db.execute<StatsRow>(sql`
    SELECT
      COUNT(*) FILTER (WHERE status IN ('sent', 'opened', 'clicked', 'converted')) AS total_sent,
      COUNT(*) FILTER (WHERE opened_at IS NOT NULL) AS total_opened,
      COUNT(*) FILTER (WHERE clicked_at IS NOT NULL) AS total_clicked
    FROM ${messageLogs}
    WHERE shop_id = ${shopId}
      AND automation_id = ${automationId}::uuid
      AND status IN ('sent', 'opened', 'clicked', 'converted')
  `)

  const row = rows[0]
  const totalSent = Number(row?.total_sent ?? 0)
  const totalOpened = Number(row?.total_opened ?? 0)
  const totalClicked = Number(row?.total_clicked ?? 0)

  return {
    totalSent,
    totalOpened,
    totalClicked,
    openRate: totalSent > 0 ? Math.round((totalOpened / totalSent) * 100) : 0,
    clickRate: totalSent > 0 ? Math.round((totalClicked / totalSent) * 100) : 0,
  }
}
```

**Part B: Update customer profile message history (src/app/(dashboard)/customers/[id]/page.tsx)**

Replace the current Message History table's "Status", "Opened", and "Clicked" columns with a single "Engagement" column approach using status icons. Update the table to match TRACK-03 requirements:

1. Keep the existing columns: Date, Subject, Automation, Status.
2. Replace the separate "Opened" and "Clicked" text columns with icon-based display within the Status column or as a dedicated "Engagement" column.
3. The status display logic:
   - If `clickedAt` is set: show link icon (use text "Clicked" with a distinct color) and the clickedAt timestamp
   - Else if `openedAt` is set: show eye text ("Opened") with green color and the openedAt timestamp
   - Else if status is 'sent': show checkmark text ("Sent") with blue color and sentAt timestamp
   - Else: show the existing status badge (suppressed, failed, etc.)

Specifically, update the thead to have these columns: Date, Subject, Automation, Status, Engagement (replace the old Opened/Clicked columns with one "Engagement" column).

The engagement column cell:
```tsx
<td className="py-3 text-xs">
  {msg.clickedAt ? (
    <span className="inline-flex items-center gap-1 text-blue-600">
      <span>Clicked</span>
      <span className="text-muted-foreground">{formatDateTime(msg.clickedAt)}</span>
    </span>
  ) : msg.openedAt ? (
    <span className="inline-flex items-center gap-1 text-green-600">
      <span>Opened</span>
      <span className="text-muted-foreground">{formatDateTime(msg.openedAt)}</span>
    </span>
  ) : msg.status === 'sent' ? (
    <span className="text-muted-foreground">No engagement yet</span>
  ) : null}
</td>
```

**Part C: Add open/click rate section to automation detail page (src/app/(dashboard)/automations/[id]/page.tsx)**

1. Import `getAutomationEmailStats` from `@/lib/db/queries`.
2. In the component, after fetching the automation, also call:
   ```typescript
   const stats = await getAutomationEmailStats(shopId, id)
   ```
3. Add a new section AFTER the heading/badge and BEFORE the Configuration section:
   ```tsx
   {/* Email Performance section */}
   <div className="rounded-lg border bg-card p-6">
     <h2 className="text-lg font-medium mb-4">Email Performance</h2>
     <p className="text-xs text-muted-foreground mb-4">
       Open rates may be inflated by Apple Mail Privacy Protection (MPP). Click rate is the more reliable metric.
     </p>
     <div className="grid grid-cols-2 sm:grid-cols-5 gap-4">
       <div>
         <p className="text-xs text-muted-foreground mb-1">Total Sent</p>
         <p className="text-2xl font-semibold tabular-nums">{stats.totalSent}</p>
       </div>
       <div>
         <p className="text-xs text-muted-foreground mb-1">Opened</p>
         <p className="text-2xl font-semibold tabular-nums">{stats.totalOpened}</p>
       </div>
       <div>
         <p className="text-xs text-muted-foreground mb-1">Clicked</p>
         <p className="text-2xl font-semibold tabular-nums">{stats.totalClicked}</p>
       </div>
       <div>
         <p className="text-xs text-muted-foreground mb-1">Open Rate</p>
         <p className="text-2xl font-semibold tabular-nums">{stats.openRate}%</p>
       </div>
       <div>
         <p className="text-xs text-muted-foreground mb-1">Click Rate</p>
         <p className="text-2xl font-semibold tabular-nums">{stats.clickRate}%</p>
       </div>
     </div>
   </div>
   ```
4. The `stats` fetch should run concurrently with the automation query. Restructure:
   ```typescript
   const [automationRows, stats] = await Promise.all([
     db.select().from(automations).where(and(eq(automations.id, id), eq(automations.shopId, shopId))).limit(1),
     getAutomationEmailStats(shopId, id),
   ])
   const automation = automationRows[0]
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors. Verify:
    1. Customer profile message history table shows an "Engagement" column with clicked/opened/no-engagement states.
    2. The old separate "Opened" and "Clicked" columns are replaced by the single "Engagement" column.
    3. Automation detail page has an "Email Performance" section with 5 stats: Total Sent, Opened, Clicked, Open Rate, Click Rate.
    4. MPP limitation is noted in the automation detail performance section.
    5. `getAutomationEmailStats` uses SQL FILTER clause for efficient aggregation.
  </verify>
  <done>
    Customer profile message history uses status icons (Clicked > Opened > Sent > other) with timestamps in a single Engagement column. Automation detail page shows per-flow open rate and click rate with MPP caveat. getAutomationEmailStats query function aggregates from message_logs.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors across all modified files.
2. `sendMarketingEmail` pre-inserts messageLog to get id, then injects tracking pixel and rewrites links.
3. Tracking pixel URL format: `{APP_URL}/api/track/open?id={messageLogId}`.
4. Click tracking URL format: `{APP_URL}/api/track/click?id={messageLogId}&url={encodedOriginalUrl}`.
5. Unsubscribe links (containing '/unsubscribe') are NOT rewritten.
6. Customer profile shows Engagement column with Clicked/Opened/No-engagement states.
7. Automation detail shows Email Performance section with 5 metric cards.
8. MPP documented in both code comment (send.ts) and UI text (automation detail).
</verification>

<success_criteria>
- Every outgoing marketing email contains tracking pixel and rewritten links
- Unsubscribe links remain direct (not rewritten)
- Customer profile message history shows engagement status icons with timestamps
- Automation detail page displays per-flow open rate and click rate
- Apple MPP limitation documented in code and UI
- TypeScript strict compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-open-and-click-tracking/12-02-SUMMARY.md`
</output>
